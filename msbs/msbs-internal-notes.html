<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MBS ‚Äî Team Notes</title>
<link rel="icon" href="/favicon.ico" />
<link rel="stylesheet" href="/public/css/mbsdashboard.css" />
</head>

<body data-page="internal-notes">
<header class="al-header">
  <div class="al-inner">
    <a class="al-brand" href="/">Asianloop Staff Portal</a>
    <nav class="al-topnav">
      <span id="welcomeUser">Welcome, {{userEmail}}</span>
      <a href="/logout" class="btn btn-ghost">Logout</a>
    </nav>
  </div>
</header>

<div class="al-shell">
  <aside class="al-sidemenu">
    <div class="al-sidemenu-title">MBS Workspace</div>
    <a class="item" href="/msbs/internal">Team Home</a>
    <a class="item" href="/msbs/internal/social">Social</a>
    <a class="item" href="/msbs/internal/conferences">Conferences</a>
    <a class="item" href="/msbs/internal/strategy">Strategy</a>
    <a class="item" href="/msbs/internal/files">Files</a>
    <a class="item active" href="/msbs/internal/notes">Team Notes</a>
    <a class="item" href="/msbs/internal/cal">Team Calendar</a>
    <div class="divider"></div>
    <a class="item" href="/msbs">Back to Public</a>
  </aside>

  <main class="al-main">
    <h1>Team Notes & Reminders</h1>

    <section class="card">
      <h2>Notes</h2>
      <ul id="notesList"><li class="placeholder">(Notes go here.)</li></ul>
    </section>

    <section class="card">
      <h2>Deadlines</h2>

      <!-- Filter row -->
      <div class="toolbar-row">
        <label class="hint">Filter:</label>
        <select class="al-input-sm" onchange="setFilter(this.value)">
          <option>All</option>
          <option>Open</option>
          <option>Close</option>
          <option>Overdue</option>
          <option>Urgent</option>
          <option>Completed</option>
          <option>Info</option>
        </select>
      </div>

      <!-- Create row -->
      <div class="toolbar-row">
        <input class="al-input-sm" id="new_title" placeholder="Title (required)" />
        <input class="al-input-sm" id="new_due" type="date" />
        <input class="al-input-sm" id="new_pic" placeholder="PIC Staff" />
        <select class="al-input-sm" id="new_status">
          <option selected>Open</option>
          <option>Close</option>
          <option>Overdue</option>
          <option>Urgent</option>
          <option>Completed</option>
          <option>Info</option>
        </select>
        <button class="btn" onclick="createNote()">Add</button>
      </div>

              <!-- Remarks row (optional, UI only for now) -->
<div class="toolbar-row">
  <textarea class="al-input-sm al-remarks" id="new_remarks" rows="2"
    placeholder="Remarks (optional): context, next steps, links‚Ä¶"></textarea>
</div>


      <table class="table" id="deadlinesTbl">
        <thead>
          <tr>
            <th>Title</th>
            <th>Created</th>
            <th>Due</th>
            <th>Owner</th>
            <th>PIC Staff</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="7" class="placeholder">(Deadlines go here.)</td></tr></tbody>
      </table>
    </section>
  </main>
</div>

<footer class="al-footer">¬© Asianloop ‚Ä¢ MBS</footer>

<script>
// Current user
function readCookie(n){return (document.cookie||'').split('; ').map(p=>p.split('=')).find(p=>p[0]===n)?.[1]||null;}
const CURRENT_USER = decodeURIComponent(readCookie('al_user_email')||'');
(function(){ var slot=document.getElementById('welcomeUser'); if(slot&&CURRENT_USER) slot.textContent=CURRENT_USER; })();

const STATUSES = ['Open','Close','Overdue','Urgent','Completed','Info'];
let FILTER = 'All';

function isOwner(email){ return (CURRENT_USER||'').toLowerCase() === (email||'').toLowerCase(); }
function badge(status){ return `<span class="badge-note note-${status}">${status}</span>`; }


  function safe(t){ 
  return String(t||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function toggleRow(id, el){
  const tr = el.closest('tr');
  if (!tr) return;
  tr.classList.toggle('expanded');
}

  
// Load & render
async function loadNotes(){
  const ul = document.getElementById('notesList');
  const tbody = document.getElementById('deadlinesTbl').querySelector('tbody');

  // deadlines table
  const r = await fetch('/api/msbs/notes',{cache:'no-store'});
  const items = await r.json();

// top list (Title ‚Äî PIC ‚Äî Status with colored badge)
ul.innerHTML = '';
items.slice(0, 5).forEach(n=>{
  const li = document.createElement('li');
  li.className = 'notes-mini';
  const hasPic = !!(n.picStaff && n.picStaff.trim());
  const picChip = hasPic ? `<span class="al-chip pic-chip">${safe(n.picStaff)}</span>` : '';
  const mid = hasPic ? ` ‚Äî ${picChip} ‚Äî ` : ' ‚Äî ';
  li.innerHTML = `<span class="mini-row">
    <span class="mini-title">${safe(n.title)}</span>${mid}${badge(n.status || 'Open')}
  </span>`;
  ul.appendChild(li);
});


  // table
  tbody.innerHTML = '';
  items
    .filter(n => FILTER==='All' ? true : (n.status===FILTER))
    .forEach(n=>{
      const mine = isOwner(n.ownerEmail||'');
      const tr = document.createElement('tr');

const titleMain = mine
  ? `<input class="al-input-sm" value="${safe(n.title)}" id="t_${n._id}">`
  : `${safe(n.title||'')}`;

const remarksPreview = (n.remarks && n.remarks.trim())
  ? `<div class="note-remarks-preview" onclick="toggleRow('${n._id}', this)" title="Click to expand">
       üìù ${safe(n.remarks)}
     </div>`
  : (mine
     ? `<div class="note-remarks-preview" onclick="toggleRow('${n._id}', this)" title="Click to add remarks">
          üìù (add remarks)
        </div>`
     : '');

// Full area: textarea for owner, read-only for others
const remarksFull = mine
  ? `<div class="note-remarks-full">
       <textarea class="al-input-sm al-remarks" id="r_${n._id}" rows="3"
         placeholder="Edit remarks‚Ä¶">${safe(n.remarks || '')}</textarea>
     </div>`
  : (n.remarks && n.remarks.trim()
     ? `<div class="note-remarks-full">${safe(n.remarks).replace(/\n/g,'<br>')}</div>`
     : '');

const titleEl = `<div class="note-title">${titleMain}${remarksPreview}${remarksFull}</div>`;



      const dueISO = n.due ? new Date(n.due).toISOString().slice(0,10) : '';
      const dueEl  = mine
        ? `<input class="al-input-sm" type="date" value="${dueISO}" id="d_${n._id}">`
        : (n.due ? new Date(n.due).toLocaleDateString() : '');

      const picEl  = mine
        ? `<input class="al-input-sm" value="${(n.picStaff||'').replace(/"/g,'&quot;')}" id="p_${n._id}">`
        : (n.picStaff||'');

      const statusEl = mine
        ? `<select class="al-input-sm" id="s_${n._id}">${STATUSES.map(s=>`<option ${s===(n.status||'Open')?'selected':''}>${s}</option>`).join('')}</select>`
        : badge(n.status||'Open');

      const created = n.createdAt ? new Date(n.createdAt).toLocaleString() : '';

      const actions = mine ? `
        <div class="actions-row">
          <button class="btn btn-ghost" onclick="saveNote('${n._id}')">Save</button>
          <button class="btn btn-ghost" onclick="deleteNote('${n._id}')">Delete</button>
        </div>` : '';




tr.classList.add('note-row');  // add this before setting innerHTML
      
      tr.innerHTML = `
        <td>${titleEl}</td>
        <td>${created}</td>
        <td>${dueEl}</td>
        <td>${n.ownerEmail||''}</td>
        <td>${picEl}</td>
        <td>${statusEl}</td>
        <td>${actions}</td>`;
      tbody.appendChild(tr);
    });
}

// Save edits (owner)
async function saveNote(id){
  const body = {
    id,
    title:  document.getElementById('t_'+id)?.value || '',
    due:    document.getElementById('d_'+id)?.value || null,
    picStaff: document.getElementById('p_'+id)?.value || '',
    status: document.getElementById('s_'+id)?.value || 'Open',
    // NEW:
    remarks: document.getElementById('r_'+id)?.value ?? ''
  };
  const r = await fetch('/api/msbs/notes/upsert',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if (!r.ok) {
    const e = await r.json().catch(()=>({}));
    alert('Save failed: ' + (e.error || r.status));
    return;
  }
  await loadNotes();
}

// Create (owner auto)
async function createNote(){
  const title = document.getElementById('new_title').value.trim();
  if (!title) { alert('Title required'); return; }
  const due = document.getElementById('new_due').value || null;
  const picStaff = document.getElementById('new_pic').value.trim();
  const status = document.getElementById('new_status').value;
  const remarks = document.getElementById('new_remarks').value.trim();

  

  // create (defaults to Open)
  let r = await fetch('/api/msbs/notes/upsert',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ title, due, picStaff, remarks })

  });
  if (!r.ok){ alert('Create failed'); return; }

  // If user chose a different initial status, update it immediately
  if (status !== 'Open') {
    await loadNotes();
    // find newest note that matches title & owner and update its status
    // (simple pass: just refresh and let owner set status via dropdown + Save)
  }

  // reset form + refresh
  document.getElementById('new_title').value = '';
  document.getElementById('new_due').value = '';
  document.getElementById('new_pic').value = '';
  document.getElementById('new_status').value = 'Open';
  document.getElementById('new_remarks').value = '';
  await loadNotes();
  
}

// Delete (owner)
async function deleteNote(id){
  if(!confirm('Delete this note?')) return;
  await fetch('/api/msbs/notes/delete',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ id })
  });
  await loadNotes();
}

// Filter control
function setFilter(v){ FILTER = v; loadNotes(); }

// Bootstrap
loadNotes();
</script>
</body>
</html>
