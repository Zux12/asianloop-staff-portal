<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MBS — Team Notes</title>
<link rel="icon" href="/favicon.ico" />
<link rel="stylesheet" href="/public/css/mbsdashboard.css" />

</head>
<body data-page="internal-notes">
<header class="al-header">
<div class="al-inner">
<a class="al-brand" href="/">Asianloop Staff Portal</a>
<nav class="al-topnav">
<span id="welcomeUser">Welcome, {{userEmail}}</span>
<a href="/logout" class="btn btn-ghost">Logout</a>
</nav>
</div>
</header>

<div class="al-shell">
<aside class="al-sidemenu">
<div class="al-sidemenu-title">MBS Workspace</div>
<a class="item" href="/msbs/internal">Team Home</a>
<a class="item" href="/msbs/internal/social">Social</a>
<a class="item" href="/msbs/internal/conferences">Conferences</a>
<a class="item" href="/msbs/internal/strategy">Strategy</a>
<a class="item" href="/msbs/internal/files">Files</a>
<a class="item active" href="/msbs/internal/notes">Team Notes</a>
<div class="divider"></div>
<a class="item" href="/msbs">Back to Public</a>
</aside>

<main class="al-main">
<h1>Team Notes & Reminders</h1>

<section class="card">
<h2>Notes</h2>
<!-- MONGO: simple notes collection or reuse msbs_announcements with internal flag -->
<ul id="notesList"><li class="placeholder">(Notes go here.)</li></ul>
  <button class="btn" onclick="addNote()">+ Add Note</button>

</section>

<section class="card">
<h2>Deadlines</h2>
<table class="table" id="deadlinesTbl">


  <thead>
  <tr>
    <th>Title</th>
    <th>Created</th>
    <th>Due</th>
    <th>Owner</th>
    <th>PIC Staff</th>
    <th>Status</th>
    <th>Actions</th>
  </tr>
</thead>

<tbody><tr><td colspan="4" class="placeholder">(Deadlines go here.)</td></tr></tbody>
</table>
</section>
</main>
</div>

<footer class="al-footer">© Asianloop • MBS</footer>

 <script>
(async function(){
  const tbody=document.getElementById('deadlinesTbl').querySelector('tbody');
  try{
    const r=await fetch('/api/msbs/notes',{cache:'no-store'});
    const items=await r.json();
    tbody.innerHTML='';
    items.forEach(n=>{
      const tr=document.createElement('tr');
      const created = n.createdAt ? new Date(n.createdAt).toLocaleString() : '';
      const due = n.due ? new Date(n.due).toLocaleDateString() : '';

      tr.innerHTML=`
        <td>${n.title}</td>
        <td>${created}</td>
        <td>${due}</td>
        <td>${n.ownerEmail}</td>
        <td>${n.picStaff||''}</td>
        <td>${n.status}</td>
        <td>
          ${isOwner(n.ownerEmail) ? `
            <button onclick="editNote('${n._id}')">Edit</button>
            <button onclick="deleteNote('${n._id}')">Delete</button>
          `:''}
        </td>`;
      tbody.appendChild(tr);
    });
  }catch(_){}
})();

function isOwner(email){
  var slot=document.getElementById('welcomeUser');
  return slot && slot.textContent.includes(email);
}

async function editNote(id){
  const status=prompt('New Status? (Open/Close/Overdue/Urgent/Completed/Info)');
  if(!status) return;
  await fetch('/api/msbs/notes/upsert',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,status})});
  location.reload();
}

async function deleteNote(id){
  if(!confirm('Delete this note?')) return;
  await fetch('/api/msbs/notes/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
  location.reload();
}

async function addNote(){
  const title=prompt('Note title?'); if(!title) return;
  const due=prompt('Due date (YYYY-MM-DD)?');
  const pic=prompt('PIC Staff?');
  await fetch('/api/msbs/notes/upsert',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,due,picStaff:pic})});
  location.reload();
}
</script>


</body>
</html>
