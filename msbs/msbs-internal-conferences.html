<!DOCTYPE html>
<link rel="stylesheet" href="/public/css/mbsdashboard.css" />

</head>
<body data-page="internal-conferences">
<header class="al-header">
<div class="al-inner">
<a class="al-brand" href="/">Asianloop Staff Portal</a>
<nav class="al-topnav">
<span id="welcomeUser">Welcome, {{userEmail}}</span>
<a href="/logout" class="btn btn-ghost">Logout</a>
</nav>
</div>
</header>

<div class="al-shell">
<aside class="al-sidemenu">
<div class="al-sidemenu-title">MBS Workspace</div>
<a class="item" href="/msbs/internal">Team Home</a>
<a class="item" href="/msbs/internal/social">Social</a>
<a class="item active" href="/msbs/internal/conferences">Conferences</a>
<a class="item" href="/msbs/internal/strategy">Strategy</a>
<a class="item" href="/msbs/internal/files">Files</a>
<a class="item" href="/msbs/internal/notes">Team Notes</a>
  <a class="item" href="/msbs/internal/cal">Team Calendar</a>
<div class="divider"></div>
<a class="item" href="/msbs">Back to Public</a>
</aside>

<main class="al-main">
<h1>Conference Tracker</h1>

<section class="card">
  <h2>Add Event (Manual)</h2>
  <div class="al-form">
    <input class="al-input" id="evName" placeholder="Event name (required)"/>
    <input class="al-input" id="evCity" placeholder="City"/>
    <input class="al-input" id="evCountry" placeholder="Country"/>
    <input class="al-input" id="evStart" type="date" placeholder="Start date (required)"/>
    <input class="al-input" id="evEnd" type="date" placeholder="End date"/>
    <input class="al-input" id="evUrl" placeholder="https://link"/>
    <button class="btn" id="evAddBtn">Add</button>
  </div>
  <small class="hint">Tip: only <strong>Name</strong> and <strong>Start date</strong> are required.</small>
</section>

  
<section class="card">
<h2>Events (from public list)</h2>
<!-- MONGO: join msbs_events with msbs_conferences to show per-event status & checklist -->
<table class="table" id="confTable">
<thead><tr><th>Event</th><th>Dates</th><th>Location</th><th>Status</th><th>Checklist</th><th>Owner</th></tr></thead>
<tbody><tr><td colspan="6" class="placeholder">(Events with internal status will appear here.)</td></tr></tbody>
</table>
</section>

<section class="card">
<h2>Materials Checklist Legend</h2>
<ul>
<li>One‑pager • Banner • Slides • Video • QR</li>
</ul>
</section>
</main>
</div>
  <div id="al-toast" class="al-toast">Saved</div>


<footer class="al-footer">© Asianloop • MBS</footer>

  <script>
// Fill "Welcome, ..." from cookie
(function () {
  var slot = document.getElementById('welcomeUser');
  function readCookie(name) {
    var cookies = (document.cookie || '').split('; ');
    for (var i = 0; i < cookies.length; i++) {
      var p = cookies[i], eq = p.indexOf('=');
      if (eq > -1 && decodeURIComponent(p.slice(0,eq)) === name) return decodeURIComponent(p.slice(eq+1));
    }
    return null;
  }
  var email = readCookie('al_user_email');
  if (slot && email) slot.textContent = email;
})();

// Small helper: toast
function showToast(msg, ok){
  var t = document.getElementById('al-toast');
  if (!t) return alert(msg);
  t.textContent = msg;
  t.className = 'al-toast ' + (ok ? 'ok' : 'err') + ' show';
  setTimeout(function(){ t.className = 'al-toast'; }, 1800);
}

// Build a status <select>
function makeStatusSelect(val){
  var s = document.createElement('select');
  ['Target','Applied','Confirmed','Not attending'].forEach(function(opt){
    var o = document.createElement('option'); o.value = opt; o.textContent = opt; s.appendChild(o);
  });
  s.value = val || 'Target';
  s.className = 'al-input';
  return s;
}
// Simple checkbox
function makeCB(checked){
  var i = document.createElement('input');
  i.type = 'checkbox'; i.checked = !!checked; i.className = 'al-cb';
  return i;
}

// Load & render
(async function(){
  var tbody = document.querySelector('#confTable tbody');
  if (!tbody) return;

  try {
    var r = await fetch('/api/msbs/conferences', { cache:'no-store' });
    if (!r.ok) throw new Error('Load failed');
    var data = await r.json();
    var items = Array.isArray(data.items) ? data.items : [];
    if (!items.length) return;

    tbody.innerHTML = '';
    items.forEach(function(row){
      var tr = document.createElement('tr');

      // name/dates/location/url cell values
      var tdName = document.createElement('td'); tdName.textContent = row.name;
      var tdDates = document.createElement('td'); tdDates.textContent = row.dates || '';
      var tdLoc  = document.createElement('td'); tdLoc.textContent  = row.location || '';
      var tdStatus = document.createElement('td');
      var tdChecklist = document.createElement('td');
      var tdOwner = document.createElement('td');
      var tdActions = document.createElement('td');

      // status
      var sel = makeStatusSelect(row.status);
      tdStatus.appendChild(sel);

      // checklist (5 toggles inline)
      var cl = row.checklist || {};
      var c1 = makeCB(cl.onePager), c2 = makeCB(cl.banner), c3 = makeCB(cl.slides), c4 = makeCB(cl.video), c5 = makeCB(cl.qr);
      var wrap = document.createElement('div'); wrap.className = 'al-checks';
      [['One-pager',c1],['Banner',c2],['Slides',c3],['Video',c4],['QR',c5]].forEach(function(pair){
        var lab = document.createElement('label'); lab.className = 'al-chip';
        lab.appendChild(pair[1]); lab.appendChild(document.createTextNode(' ' + pair[0]));
        wrap.appendChild(lab);
      });
      tdChecklist.appendChild(wrap);

      // owner
      var owner = document.createElement('input'); owner.className = 'al-input'; owner.type = 'email';
      owner.placeholder = 'owner@asian-loop.com'; owner.value = row.ownerEmail || '';
      tdOwner.appendChild(owner);

      // actions
      var btn = document.createElement('button'); btn.textContent = 'Save'; btn.className = 'btn';
      btn.addEventListener('click', async function(){
        try {
          var payload = {
            name: row.name,
            year: row.year,
            status: sel.value,
            ownerEmail: owner.value.trim(),
            checklist: {
              onePager: c1.checked, banner: c2.checked, slides: c3.checked, video: c4.checked, qr: c5.checked
            }
          };
          var pr = await fetch('/api/msbs/conferences/upsert', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!pr.ok) throw new Error('Save failed');
          showToast('Saved ✔', true);
        } catch(e){ showToast('Error saving', false); }
      });
      tdActions.appendChild(btn);

      tr.appendChild(tdName);
      tr.appendChild(tdDates);
      tr.appendChild(tdLoc);
      tr.appendChild(tdStatus);
      tr.appendChild(tdChecklist);
      tr.appendChild(tdOwner);
      tr.appendChild(tdActions);
      tbody.appendChild(tr);
    });
  } catch (_err) {
    // leave placeholder row if load fails
  }
})();

// Manual Add handler
(function(){
  var btn = document.getElementById('evAddBtn');
  if (!btn) return;
  btn.addEventListener('click', async function(){
    var b = {
      name: document.getElementById('evName').value.trim(),
      city: document.getElementById('evCity').value.trim(),
      country: document.getElementById('evCountry').value.trim(),
      startDate: document.getElementById('evStart').value,
      endDate: document.getElementById('evEnd').value || null,
      url: document.getElementById('evUrl').value.trim()
    };
    if (!b.name || !b.startDate) return showToast('Name & Start date required', false);
    try{
      var r = await fetch('/api/msbs/events/add', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(b)
      });
      if (!r.ok) throw 0;
      showToast('Event added ✔', true);
      setTimeout(function(){ location.reload(); }, 600);
    }catch(_){ showToast('Add failed', false); }
  });
})();

</script>

</body>
</html>
