<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Licenses — Asianloop Admin</title>
<style>
  :root{
    --bg:#fff; --ink:#0f172a; --muted:#64748b; --card:#fafafa; --border:#e5e7eb;
    --accent:#2563eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--border);
    padding:14px 20px;display:flex;align-items:center;gap:12px}
  header h1{font-size:18px;margin:0}
  header a.back{font-size:13px;color:var(--muted);text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  main{max-width:1100px;margin:0 auto;padding:18px 20px 40px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{font-size:14px;padding:9px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  input,select{border:1px solid var(--border);border-radius:10px;padding:9px 12px;font-size:14px}
  .hint{font-size:12px;color:var(--muted)}
  .table{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);text-align:left;padding:10px}
  tbody td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top}
  tbody tr:hover{background:#fcfcfc}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);color:var(--muted)}
  .status.active{color:var(--ok);border-color:#ccebd6}
  .status.expiring{color:var(--warn);border-color:#f5d9a6}
  .status.expired{color:var(--bad);border-color:#f3b5b5}
  .right{display:flex;gap:6px;justify-content:flex-end}
  dialog{border:none;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:0;max-width:640px;width:96%}
  .dlg-h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600}
  .dlg-b{padding:16px;display:grid;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .dlg-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
  .muted{color:var(--muted)}
  .link{color:var(--accent);text-decoration:none}
</style>
</head>
<body>
<header>
  <a class="back" href="/public/admin.html">← Admin</a>
  <h1>Licenses</h1>
</header>
<main>
  <div class="bar">
    <input id="q" placeholder="Search name/vendor…" />
    <select id="fStatus">
      <option value="">All statuses</option>
      <option value="active">Active</option>
      <option value="expiring">Expiring (≤30d)</option>
      <option value="expired">Expired</option>
    </select>
    <select id="fType">
      <option value="">All types</option>
      <option>Software</option><option>Instrument</option><option>Site</option><option>Other</option>
    </select>
    <button class="btn" id="btnRefresh">Refresh</button>
    <div style="flex:1"></div>
    <button class="btn primary" id="btnNew">New License</button>
  </div>

  <div class="table">
    <table id="tbl">
      <thead>
        <tr>
          <th style="width:24%">Name</th>
          <th style="width:10%">Type</th>
          <th style="width:16%">Vendor</th>
          <th style="width:12%">Start</th>
          <th style="width:12%">Expiry</th>
          <th style="width:10%">Status</th>
          <th>Proof</th>
          <th style="width:150px"></th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="8" class="muted" style="padding:14px">Loading…</td></tr></tbody>
    </table>
  </div>

  <p class="hint" style="margin-top:10px">Proof upload limit: <strong>5 MB</strong> (PDF/JPG/PNG). Larger files will be rejected.</p>
</main>

<!-- Add/Edit dialog -->
<dialog id="dlg">
  <div class="dlg-h" id="dlgTitle">New License</div>
  <form id="frm" class="dlg-b">
    <div class="grid2">
      <label>Name<br><input name="name" required></label>
      <label>Type<br>
        <select name="type" required>
          <option>Software</option><option>Instrument</option><option>Site</option><option>Other</option>
        </select>
      </label>
    </div>
    <div class="grid2">
      <label>Vendor<br><input name="vendor"></label>
      <label>Seats/Qty<br><input name="seats" type="number" min="0" step="1" placeholder="0"></label>
    </div>
    <div class="grid2">
      <label>Start Date<br><input name="startAt" type="date" required></label>
      <label>Expiry Date<br><input name="endAt" type="date" required></label>
    </div>
    <label>Notes<br><input name="notes" placeholder="Optional description"></label>
    <input type="hidden" name="_id" />
  </form>
  <div class="dlg-f">
    <button class="btn" id="btnCancel">Cancel</button>
    <button class="btn primary" id="btnSave">Save</button>
  </div>
</dialog>

<!-- Proof upload dialog -->
<dialog id="dlgUp">
  <div class="dlg-h">Upload Proof (max 5 MB)</div>
  <div class="dlg-b">
    <input id="fileProof" type="file" accept=".pdf,.jpg,.jpeg,.png" />
    <div class="hint">Accepted: PDF, JPG, PNG. Max 5 MB.</div>
  </div>
  <div class="dlg-f">
    <button class="btn" id="btnUpCancel">Cancel</button>
    <button class="btn primary" id="btnUpload">Upload</button>
  </div>
</dialog>

<script>
  const $ = (q, el=document) => el.querySelector(q);
  const rowsEl = $('#rows');
  let data = [];
  let uploadId = null;

  function fmt(d){ if(!d) return ''; const x=new Date(d); return isNaN(x)?'':x.toISOString().slice(0,10); }
  function daysUntil(dateStr){
    const d=new Date(dateStr); if(isNaN(d)) return null;
    const today=new Date(); today.setHours(0,0,0,0); d.setHours(0,0,0,0);
    return Math.round((d - today)/86400000);
  }
  function statusOf(item){
    const n=daysUntil(item.endAt);
    if(n===null) return {k:'', label:''};
    if(n<0) return {k:'expired', label:'Expired'};
    if(n<=30) return {k:'expiring', label:`Expiring (${n}d)`};
    return {k:'active', label:`Active (${n}d)`};
  }

  function render(){
    const q = $('#q').value.trim().toLowerCase();
    const s = $('#fStatus').value;
    const t = $('#fType').value;
    const filtered = data.filter(x=>{
      const st = statusOf(x).k;
      const okQ = !q || (x.name?.toLowerCase().includes(q) || x.vendor?.toLowerCase().includes(q));
      const okS = !s || st===s;
      const okT = !t || x.type===t;
      return okQ && okS && okT;
    });
    if(!filtered.length){ rowsEl.innerHTML = `<tr><td colspan="8" class="muted" style="padding:14px">No licenses</td></tr>`; return; }
    rowsEl.innerHTML = filtered.map(x=>{
      const st=statusOf(x);
const proof = x.proofFileId ? `<a class="link" href="/api/licensefile/${x.proofFileId}" target="_blank">Download</a>` : `<span class="muted">None</span>`;
      return `<tr>
        <td>${escapeHtml(x.name||'')}</td>
        <td>${escapeHtml(x.type||'')}</td>
        <td>${escapeHtml(x.vendor||'')}</td>
        <td>${fmt(x.startAt)}</td>
        <td>${fmt(x.endAt)}</td>
        <td><span class="status ${st.k}">${st.label}</span></td>
        <td>${proof}</td>
        <td class="right">
          <button class="btn" onclick='openUpload("${x._id}")'>Proof</button>
          <button class="btn" onclick='openEdit("${x._id}")'>Edit</button>
          <button class="btn" onclick='doDelete("${x._id}")'>Delete</button>
        </td>
      </tr>`;
    }).join('');
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  async function load(){
    try{
      const r = await fetch('/api/licenses');
      const j = await r.json();
      data = Array.isArray(j)? j : (j.items||[]);
    }catch(e){
      data = [];
      console.error(e);
    }
    render();
  }

  // dialogs
  const dlg = $('#dlg'); const frm = $('#frm');
  $('#btnNew').onclick = ()=>{ frm.reset(); $('#dlgTitle').textContent='New License'; dlg.showModal(); }
  $('#btnCancel').onclick = ()=> dlg.close();
  $('#btnSave').onclick = async ()=>{
    const obj = Object.fromEntries(new FormData(frm).entries());
    if(!obj.name || !obj.type || !obj.startAt || !obj.endAt){ alert('Please fill required fields'); return; }
    obj.seats = obj.seats ? Number(obj.seats) : 0;
    let method='POST', url='/api/licenses';
    if(obj._id){ method='PUT'; url=`/api/licenses/${obj._id}`; }
    const r = await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});
    if(!r.ok){ alert('Save failed'); return; }
    dlg.close(); await load();
  };

  function openEdit(id){
    const x = data.find(y=>y._id===id); if(!x) return;
    frm.name.value = x.name||''; frm.type.value=x.type||'Software';
    frm.vendor.value = x.vendor||''; frm.seats.value = x.seats||'';
    frm.startAt.value = fmt(x.startAt); frm.endAt.value = fmt(x.endAt);
    frm.notes.value = x.notes||''; frm._id.value = x._id;
    $('#dlgTitle').textContent='Edit License';
    dlg.showModal();
  }

  async function doDelete(id){
    if(!confirm('Delete this license?')) return;
    const r = await fetch(`/api/licenses/${id}`, {method:'DELETE'});
    if(!r.ok){ alert('Delete failed'); return; }
    await load();
  }

  const dlgUp = $('#dlgUp'); const fileProof = $('#fileProof');
  $('#btnUpCancel').onclick = ()=> dlgUp.close();
  function openUpload(id){ uploadId = id; fileProof.value=''; dlgUp.showModal(); }
  window.openUpload = openUpload; window.openEdit = openEdit; window.doDelete = doDelete;

  $('#btnUpload').onclick = async ()=>{
    if(!uploadId){ dlgUp.close(); return; }
    const f = fileProof.files[0];
    if(!f){ alert('Choose a file'); return; }
    if(f.size > 5*1024*1024){ alert('File exceeds 5 MB'); return; }
    const fd = new FormData(); fd.append('file', f);
    const r = await fetch(`/api/licenses/${uploadId}/upload`, { method:'POST', body: fd });
    if(!r.ok){ alert('Upload failed'); return; }
    dlgUp.close(); await load();
  };

  $('#q').oninput = render; $('#fStatus').onchange = render; $('#fType').onchange = render;
  $('#btnRefresh').onclick = load;

  load();
</script>
</body>
</html>
