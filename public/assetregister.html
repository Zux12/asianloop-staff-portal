<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Asset Register — Asianloop Admin</title>
<style>
  :root{
    --bg:#fff; --ink:#0f172a; --muted:#64748b; --card:#fafafa; --border:#e5e7eb;
    --accent:#2563eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--border);
    padding:14px 20px;display:flex;align-items:center;gap:12px}
  header h1{font-size:18px;margin:0}
  header a.back{font-size:13px;color:var(--muted);text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  main{max-width:1100px;margin:0 auto;padding:18px 20px 40px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{font-size:14px;padding:9px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  input,select,textarea{border:1px solid var(--border);border-radius:10px;padding:9px 12px;font-size:14px}
  .muted{color:var(--muted)}
  .hint{font-size:12px;color:var(--muted)}

  /* Table wrapper */
  .table{
    border:1px solid var(--border);
    border-radius:14px;
    background:#fff;
    overflow:visible;
    padding-right:14px;
  }
  table{
    width:100%;
    border-collapse:collapse;
    table-layout:fixed;
    min-width:1100px;
    font-size:14px;
  }
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);text-align:left;padding:10px}
  tbody td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top}
  tbody tr:hover{background:#fcfcfc}
  thead th.actions{ text-align:right; }
  td.actions{
    white-space:normal; overflow:visible; display:flex; flex-wrap:wrap; gap:6px;
    justify-content:flex-end; align-items:center; padding-right:12px;
  }
  td.actions .btn{ font-size:12px; padding:5px 8px; line-height:1.2; }

  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
  .status.active{color:var(--ok);border-color:#ccebd6}
  .status.repair{color:var(--warn);border-color:#f5d49e}
  .status.retired{color:var(--bad);border-color:#f3b5b5}

  dialog{border:none;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:0;max-width:880px;width:96%}
  .dlg-h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600}
  .dlg-b{padding:16px;display:grid;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .grid1{display:grid;grid-template-columns:1fr;gap:10px}
  .dlg-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}

  /* Make inputs fill columns in dialog */
  #dlg label{ display:block }
  #dlg input, #dlg select, #dlg textarea { width:100% }

  @media (max-width:900px){
    .grid2, .grid3{ grid-template-columns:1fr }
  }
</style>
</head>
<body>
<header>
  <a class="back" href="/public/admin.html">← Admin</a>
  <h1>Asset Register</h1>
</header>

<main>
  <div class="bar">
    <input id="q" placeholder="Search tag/name/location/vendor/serial…" />
    <select id="fStatus">
      <option value="">All status</option>
      <option value="Active">Active</option>
      <option value="Under Repair">Under Repair</option>
      <option value="Retired">Retired</option>
    </select>
    <select id="fCategory">
      <option value="">All categories</option>
      <option>Instrument</option>
      <option>Software</option>
      <option>IT/Hardware</option>
      <option>Facility</option>
      <option>Other</option>
    </select>
    <button class="btn" id="btnRefresh">Refresh</button>
    <div style="flex:1"></div>
    <button class="btn primary" id="btnNew">Add Asset</button>
  </div>

  <div class="table">
    <table id="tbl">
      <colgroup>
        <col style="width:16%"><!-- Asset Tag -->
        <col style="width:22%"><!-- Name -->
        <col style="width:12%"><!-- Category -->
        <col style="width:14%"><!-- Location -->
        <col style="width:12%"><!-- Status -->
        <col style="width:12%"><!-- Warranty End -->
        <col style="width:12%"><!-- Actions -->
      </colgroup>
      <thead>
        <tr>
          <th>Asset Tag</th>
          <th>Name</th>
          <th>Category</th>
          <th>Location</th>
          <th>Status</th>
          <th>Warranty</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="7" class="muted" style="padding:14px">Loading…</td></tr></tbody>
    </table>
  </div>

  <p class="hint" style="margin-top:10px">Tip: Use consistent tags (e.g., AL-INS-0012) and keep locations short (e.g., Lab A, Store 2).</p>
</main>

<!-- Add/Edit dialog -->
<dialog id="dlg">
  <div class="dlg-h" id="dlgTitle">Add Asset</div>
  <form id="frm" class="dlg-b">
    <input type="hidden" name="_id" id="hid_id" value="">

    <div class="grid2">
      <label>Asset Tag<br><input name="assetTag" required placeholder="e.g., AL-INS-0012"></label>
      <label>Name<br><input name="name" required placeholder="e.g., Ultrasonic Flowmeter"></label>
    </div>

    <div class="grid3">
      <label>Category<br>
        <select name="category" required>
          <option>Instrument</option>
          <option>Software</option>
          <option>IT/Hardware</option>
          <option>Facility</option>
          <option>Other</option>
        </select>
      </label>
      <label>Location<br><input name="location" placeholder="e.g., Lab A"></label>
      <label>Status<br>
        <select name="status" required>
          <option>Active</option>
          <option>Under Repair</option>
          <option>Retired</option>
        </select>
      </label>
    </div>

    <div class="grid3">
      <label>Vendor<br><input name="vendor" placeholder="e.g., Endress+Hauser"></label>
      <label>Serial No.<br><input name="serialNo" placeholder="e.g., 9A-12345"></label>
      <label>Cost (MYR)<br><input name="cost" type="number" step="0.01" min="0" placeholder="e.g., 12000"></label>
    </div>

    <div class="grid3">
      <label>Purchase Date<br><input name="purchaseDate" type="date"></label>
      <label>Warranty End<br><input name="warrantyEnd" type="date"></label>
      <label>Assigned Owner (email)<br><input name="ownerEmail" type="email" placeholder="user@asian-loop.com"></label>
    </div>

    <div class="grid1">
      <label>Notes<br><textarea name="notes" rows="3" placeholder="Calibration schedule, accessories, etc."></textarea></label>
    </div>
  </form>
  <div class="dlg-f">
    <button class="btn" id="btnCancel">Cancel</button>
    <button class="btn primary" id="btnSave">Save</button>
  </div>
</dialog>

<!-- Details dialog -->
<dialog id="dlgDetails">
  <div class="dlg-h">Asset details</div>
  <div class="dlg-b" id="detailsBody" style="max-height:60vh;overflow:auto"></div>
  <div class="dlg-f">
    <button class="btn" id="btnDetClose">Close</button>
  </div>
</dialog>

<script>
const $ = (q, el=document) => el.querySelector(q);
const rowsEl = $('#rows'); let data = [];

function fmtDate(d){ if(!d) return ''; const x=new Date(d); return isNaN(x)?'':x.toISOString().slice(0,10); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }
const statusClass = s => s==='Active' ? 'active' : (s==='Retired' ? 'retired' : 'repair');


function buildAssetRow(x){
  const id = String((x && x._id) || '');
  const esc = escapeHtml;
  return [
    '<tr>',
      '<td>', esc(x.assetTag || ''), '</td>',
      '<td>', esc(x.name || ''), '</td>',
      '<td>', esc(x.category || ''), '</td>',
      '<td>', esc(x.location || ''), '</td>',
      '<td><span class="status ', (x.status==='Active' ? 'active' : (x.status==='Retired' ? 'retired' : 'repair')), '">',
          esc(x.status || ''), '</span></td>',
      '<td>', fmtDate(x.warrantyEnd), '</td>',
      '<td class="actions">',
        '<button class="btn js-det"  data-id="', id, '">Details</button>',
        '<button class="btn js-edit" data-id="', id, '">Edit</button>',
        '<button class="btn js-del"  data-id="', id, '">Delete</button>',
      '</td>',
    '</tr>'
  ].join('');
}

  
function render(){
  const q  = ($('#q')?.value || '').toLowerCase().trim();
  const fs = $('#fStatus')?.value || '';
  const fc = $('#fCategory')?.value || '';

  const filtered = (data || []).filter(x=>{
    const okQ = !q || ['assetTag','name','location','vendor','serialNo']
      .some(k => String(x[k] || '').toLowerCase().includes(q));
    const okS = !fs || x.status === fs;
    const okC = !fc || x.category === fc;
    return okQ && okS && okC;
  });

  if (!filtered.length){
    rowsEl.innerHTML = '<tr><td colspan="7" class="muted" style="padding:14px">No assets</td></tr>';
  } else {
    rowsEl.innerHTML = filtered.map(buildAssetRow).join('');
  }

  // Wire row buttons AFTER rendering
  rowsEl.querySelectorAll('.js-det').forEach(btn=>{
    btn.addEventListener('click', ()=> openDetails(btn.dataset.id));
  });
  rowsEl.querySelectorAll('.js-edit').forEach(btn=>{
    btn.addEventListener('click', ()=> openEdit(btn.dataset.id));
  });
  rowsEl.querySelectorAll('.js-del').forEach(btn=>{
    btn.addEventListener('click', ()=> doDelete(btn.dataset.id));
  });
}


async function load(){
  try{
    const r = await fetch('/api/assets', { headers:{ 'Accept':'application/json' }});
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    const j = await r.json();
    const arr = Array.isArray(j) ? j : (Array.isArray(j.items) ? j.items : []);
    data = (arr||[]).map(x=>{
      const id =
        (x && x._id && typeof x._id === 'object' && x._id.$oid) ? x._id.$oid :
        (x && typeof x._id === 'string') ? x._id :
        (x && typeof x.id  === 'string') ? x.id : '';
      return { ...x, _id:id };
    });
  }catch(e){ console.error('[assets load]', e); data=[]; }
  render();
}

const dlg = $('#dlg'); const frm = $('#frm');

$('#btnNew').onclick = ()=>{
  frm.reset();
  (document.getElementById('hid_id')||{}).value = '';
  if (frm.status) frm.status.value = 'Active';
  $('#dlgTitle').textContent = 'Add Asset';
  dlg.showModal();
};
$('#btnCancel').onclick = ()=> dlg.close();

$('#btnSave').onclick = async ()=>{
  const obj = Object.fromEntries(new FormData(frm).entries());
  obj.cost = (obj.cost===''||obj.cost==null) ? 0 : +obj.cost;
  const idField = String((document.getElementById('hid_id')?.value || '')).trim();
  const method = idField ? 'PUT' : 'POST';
  const url = idField ? `/api/assets/${encodeURIComponent(idField)}` : '/api/assets';
  if (idField) obj._id = idField; else delete obj._id;

  const r = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj) });
  if (!r.ok){
    const t = await r.text().catch(()=>r.statusText||'');
    alert('Save failed: ' + (t || `${r.status} ${r.statusText}`));
    return;
  }
  await load();
  dlg.close();
};

function openEdit(id){
  const x = (data||[]).find(y => String(y && y._id) === String(id));
  if (!x){ alert('Could not load asset'); return; }
  frm.reset();

  (document.getElementById('hid_id')||{}).value = x._id || '';
  const set=(n,v)=>{ if (frm.elements[n]) frm.elements[n].value = (v ?? ''); };
  set('assetTag', x.assetTag);
  set('name', x.name);
  set('category', x.category);
  set('location', x.location);
  set('status', x.status || 'Active');
  set('vendor', x.vendor);
  set('serialNo', x.serialNo);
  set('cost', x.cost);
  set('purchaseDate', fmtDate(x.purchaseDate));
  set('warrantyEnd', fmtDate(x.warrantyEnd));
  set('ownerEmail', x.ownerEmail);
  set('notes', x.notes);

  $('#dlgTitle').textContent = 'Edit Asset';
  dlg.showModal();
}
window.openEdit = openEdit;

function openDetails(id){
  const x = (data||[]).find(y => String(y && y._id) === String(id));
  if (!x){ alert('Could not load details'); return; }
  const b = $('#detailsBody');
  b.innerHTML = `
    <div class="grid2">
      <div><strong>Asset Tag</strong><br>${escapeHtml(x.assetTag||'')}</div>
      <div><strong>Name</strong><br>${escapeHtml(x.name||'')}</div>
    </div>
    <div class="grid3">
      <div><strong>Category</strong><br>${escapeHtml(x.category||'')}</div>
      <div><strong>Location</strong><br>${escapeHtml(x.location||'')}</div>
      <div><strong>Status</strong><br>${escapeHtml(x.status||'')}</div>
    </div>
    <div class="grid3">
      <div><strong>Vendor</strong><br>${escapeHtml(x.vendor||'')}</div>
      <div><strong>Serial No.</strong><br>${escapeHtml(x.serialNo||'')}</div>
      <div><strong>Cost (MYR)</strong><br>${(x.cost??'')}</div>
    </div>
    <div class="grid3">
      <div><strong>Purchase Date</strong><br>${fmtDate(x.purchaseDate)}</div>
      <div><strong>Warranty End</strong><br>${fmtDate(x.warrantyEnd)}</div>
      <div><strong>Owner</strong><br>${escapeHtml(x.ownerEmail||'')}</div>
    </div>
    <div><strong>Notes</strong><br>${escapeHtml(x.notes||'')}</div>
  `;
  $('#dlgDetails').showModal();
}
$('#btnDetClose').onclick = ()=> $('#dlgDetails').close();

async function doDelete(id){
  if(!confirm('Delete this asset?')) return;
  const r = await fetch(`/api/assets/${id}`, { method:'DELETE' });
  if(!r.ok){ alert('Delete failed'); return; }
  await load();
}
window.doDelete = doDelete;

$('#q').oninput = render; $('#fStatus').onchange = render; $('#fCategory').onchange = render;
$('#btnRefresh').onclick = load;

load();
</script>
</body>
</html>
