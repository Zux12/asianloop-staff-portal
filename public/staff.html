<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Staff Directory — Asianloop Admin</title>
<style>
  :root{
    --bg:#fff; --ink:#0f172a; --muted:#64748b; --card:#fafafa; --border:#e5e7eb;
    --accent:#2563eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--border);
    padding:14px 20px;display:flex;align-items:center;gap:12px}
  header h1{font-size:18px;margin:0}
  header a.back{font-size:13px;color:var(--muted);text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  main{max-width:1100px;margin:0 auto;padding:18px 20px 40px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{font-size:14px;padding:9px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  input,select{border:1px solid var(--border);border-radius:10px;padding:9px 12px;font-size:14px}
  .hint{font-size:12px;color:var(--muted)}
  .table{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);text-align:left;padding:10px}
  tbody td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top}
  tbody tr:hover{background:#fcfcfc}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
  .status.active{color:var(--ok);border-color:#ccebd6}
  .status.suspended{color:var(--bad);border-color:#f3b5b5}
  .right{display:flex;gap:6px;justify-content:flex-end}
  dialog{border:none;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:0;max-width:640px;width:96%}
  .dlg-h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600}
  .dlg-b{padding:16px;display:grid;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .dlg-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
  .muted{color:var(--muted)}
  .link{color:var(--accent);text-decoration:none}

    .fam-sec{border:1px solid var(--border);border-radius:12px;background:#fff;padding:12px}
  .fam-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .fam-rows{display:grid;gap:8px}
  .fam-row{display:grid;grid-template-columns:1.2fr 0.9fr 1fr 1fr 1fr auto;gap:8px;align-items:center}
  .fam-row input{border:1px solid var(--border);border-radius:10px;padding:9px 10px;font-size:14px;width:100%}
  @media (max-width: 900px){
    .fam-row{grid-template-columns:1fr 1fr;gap:6px}
    .fam-row button{justify-self:start}
  }

/* --- Dialog polish --- */
dialog{max-width:760px;width:96%}
.dlg-h{display:flex;align-items:center;gap:10px}
.dlg-b{max-height:60vh;overflow:auto}
.sec-title{margin:6px 0 0;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
.block{border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px}
.block + .block{margin-top:10px}
/* compact labels */
#frm label{font-size:13px;color:#111827}
#frm input, #frm select{background:#fff}
#frm .grid2{align-items:flex-start}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width: 900px){ .kv{grid-template-columns:1fr} }

/* Family table (details view) */
.fam-table{width:100%;border-collapse:collapse;font-size:14px}
.fam-table th,.fam-table td{padding:6px;text-align:left;border-bottom:1px solid var(--border)}



</style>
</head>
<body>
<header>
  <a class="back" href="/public/admin.html">← Admin</a>
  <h1>Staff Directory</h1>
</header>
<main>
  <div class="bar">
    <input id="q" placeholder="Search name/email/department…" />
    <select id="fRole">
      <option value="">All roles</option>
      <option>admin</option>
      <option>manager</option>
      <option>viewer</option>
    </select>
    <select id="fStatus">
      <option value="">All status</option>
      <option value="Active">Active</option>
      <option value="Suspended">Suspended</option>
    </select>
    <button class="btn" id="btnRefresh">Refresh</button>
    <div style="flex:1"></div>
    <button class="btn primary" id="btnNew">Add Staff</button>
  </div>

  <div class="table">
    <table id="tbl">
      <thead>
        <tr>
          <th style="width:22%">Name</th>
          <th style="width:26%">Email</th>
          <th style="width:14%">Dept</th>
          <th style="width:12%">Role</th>
          <th style="width:12%">Status</th>
          <th style="width:14%">Last login</th>
          <th style="width:170px"></th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="7" class="muted" style="padding:14px">Loading…</td></tr></tbody>
    </table>
  </div>

  <p class="hint" style="margin-top:10px">Note: Emails must be within your allowed domain (e.g., @asian-loop.com).</p>
</main>

<!-- Add/Edit dialog -->
<dialog id="dlg">
  <div class="dlg-h" id="dlgTitle">Add Staff</div>
  <form id="frm" class="dlg-b">
    <input type="hidden" name="_id" id="hid_id" value="">

<div class="sec-title">Basic</div>
<div class="block">
  <!-- Basic -->
  <div class="grid2">
    <label>Name<br><input name="name" required></label>
    <label>Email<br><input name="email" type="email" required></label>
  </div>
  <div class="grid2">
    <label>Department<br><input name="dept"></label>
    <label>Role<br>
      <select name="role" required>
        <option>viewer</option>
        <option>manager</option>
        <option>admin</option>
      </select>
    </label>
  </div>
  <div class="grid2">
    <label>Status<br>
      <select name="status" required>
        <option>Active</option>
        <option>Suspended</option>
      </select>
    </label>
    <label>MFA Enabled?<br>
      <select name="mfaEnabled">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>
    </label>
  </div>
</div>

<div class="sec-title">Employment</div>
<div class="block">
  <div class="grid2">
    <label>Staff Number<br><input name="staffNo" placeholder="e.g., AL-0012"></label>
    <label>Hire Date<br><input name="hireDate" type="date"></label>
  </div>
</div>

<div class="sec-title">Vehicle</div>
<div class="block">
  <div class="grid2">
    <label>Car Registration<br><input name="carReg" placeholder="e.g., VBR 1234"></label>
    <label>Car Make/Model<br><input name="carDesc" placeholder="e.g., Perodua Myvi"></label>
  </div>
</div>

<div class="sec-title">Identity</div>
<div class="block">
  <div class="grid2">
    <label>IC / NRIC / ID No.<br><input name="idNo" placeholder="e.g., 900101-14-5678"></label>
    <label>Passport No.<br><input name="passportNo" placeholder="e.g., A12345678"></label>
  </div>
</div>

<div class="sec-title">Address</div>
<div class="block">
  <label>Address<br><input name="address" placeholder="Street, City, State, Postcode, Country"></label>
</div>

<div class="sec-title">Next of Kin</div>
<div class="block">
  <div class="grid2">
    <label>Next of Kin — Name<br><input name="nokName" placeholder="e.g., Nur Aisyah"></label>
    <label>Relation<br><input name="nokRelation" placeholder="e.g., Spouse"></label>
  </div>
  <div class="grid2">
    <label>Phone<br><input name="nokPhone" placeholder="+60-..."></label>
    <label>Emergency Notes (optional)<br><input name="emergencyNotes" placeholder="Allergies / conditions"></label>
  </div>
</div>

<div class="sec-title">Family Members</div>
<div class="block">
  <div class="fam-sec" style="border:none;padding:0">
    <div class="fam-head">
      <strong>Members</strong>
      <button type="button" class="btn" id="btnAddFam">+ Add member</button>
    </div>
    <div class="fam-rows" id="familyRows"></div>
    <div class="hint" style="margin-top:6px">Fields: Name, Date of Birth, Relationship, Phone, Notes</div>
  </div>
</div>

<div class="sec-title">Notes</div>
<div class="block">
  <label>Notes (optional)<br><input name="notes" placeholder=""></label>
</div>


    
 

<div class="dlg-f">
  <button type="button" class="btn" id="btnCancel">Cancel</button>
  <button type="button" class="btn primary" id="btnSave">Save</button>
</div>

</dialog>

<script>
const $ = (q, el=document) => el.querySelector(q);
const rowsEl = $('#rows'); let data = [];
let lastDetails = null; // full record fetched by id (used by details & PDF)


  function fmtDate(d){ if(!d) return ''; const x=new Date(d); return isNaN(x)?'':x.toISOString().slice(0,10); }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function render(){
    const q = $('#q').value.trim().toLowerCase();
    const r = $('#fRole').value;
    const s = $('#fStatus').value;
    const filtered = data.filter(x=>{
      const okQ = !q || (x.name?.toLowerCase().includes(q) || x.email?.toLowerCase().includes(q) || x.dept?.toLowerCase().includes(q));
      const okR = !r || x.role===r;
      const okS = !s || x.status===s;
      return okQ && okR && okS;
    });
    if(!filtered.length){ rowsEl.innerHTML = `<tr><td colspan="7" class="muted" style="padding:14px">No staff</td></tr>`; return; }
    rowsEl.innerHTML = filtered.map(x=>{
      const st = x.status==='Active' ? 'active' : 'suspended';
      return `<tr>
        <td>${escapeHtml(x.name||'')}</td>
        <td>${escapeHtml(x.email||'')}</td>
        <td>${escapeHtml(x.dept||'')}</td>
        <td>${escapeHtml(x.role||'')}</td>
        <td><span class="status ${st}">${escapeHtml(x.status||'')}</span></td>
        <td>${fmtDate(x.lastLoginAt)}</td>
<td class="right">
  <button class="btn" onclick='openDetails("${x._id}")'>Full details</button>
  <button class="btn" onclick='openEdit("${x._id}")'>Edit</button>
  <button class="btn" onclick='toggleStatus("${x._id}", "${x.status||"Active"}")'>${x.status==='Active'?'Disable':'Enable'}</button>
  <button class="btn" onclick='doDelete("${x._id}")'>Delete</button>
</td>

      </tr>`;
    }).join('');
  }

async function load(){
  try{
    const r = await fetch('/api/staff', { headers:{ 'Accept':'application/json' }});
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    const j = await r.json();

    // Normalize list + IDs: handles {_id:{$oid}}, {_id:""}, or {id:""}
    const arr = Array.isArray(j) ? j : (Array.isArray(j.items) ? j.items : []);
    data = arr.map(x => {
      const id =
        (x && x._id && typeof x._id === 'object' && x._id.$oid) ? x._id.$oid :
        (x && typeof x._id === 'string') ? x._id :
        (x && typeof x.id  === 'string') ? x.id : '';
      return { ...x, _id: id };
    });
  }catch(e){
    console.error('[load]', e);
    data = [];
  }
  render();
}


  // dialogs
  const dlg = $('#dlg'); const frm = $('#frm');
$('#btnNew').onclick = ()=> openAdd();
  $('#btnCancel').onclick = ()=> dlg.close();

async function saveStaff(e){
  if (e) e.preventDefault();

  // Build payload from form
  const obj = Object.fromEntries(new FormData(frm).entries());
  obj.mfaEnabled = (obj.mfaEnabled === 'true');

  // Map family: relation -> relationship; drop fully empty rows
  const famClean = (Array.isArray(fam) ? fam : []).map(m => ({
    name: (m?.name || '').trim(),
    dob:  m?.dob || '',
    relationship: (m?.relation || m?.relationship || '').trim(),
    phone: (m?.phone || '').trim(),
    notes: (m?.notes || '').trim(),
  })).filter(m => m.name || m.relationship || m.phone || m.notes || m.dob);
  obj.family = famClean;

  // Decide create vs update
  let method = 'POST', url = '/api/staff';
  if (obj._id) { method = 'PUT'; url = `/api/staff/${obj._id}`; }

  // Disable Save to avoid double clicks
  const btn = document.getElementById('btnSave'); 
  if (btn) { btn.disabled = true; btn.textContent = 'Saving…'; }

  try{
    const r = await fetch(url, {
      method,
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(obj)
    });
    if (!r.ok){
      const t = await r.text().catch(()=>r.statusText||'');
      alert('Save failed: ' + (t || `${r.status} ${r.statusText}`));
      return;
    }
    dlg.close();
    await load(); // refresh table
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
  }
}

// Wire up both click and real form submit (Enter key)
document.getElementById('btnSave').addEventListener('click', saveStaff);
frm.addEventListener('submit', saveStaff);


function openAdd(){
  // Dialog title
  $('#dlgTitle').textContent = 'Add Staff';

  // Form defaults
  frm.reset();
  if (frm.elements['_id']) frm.elements['_id'].value = '';
  if (frm.role) frm.role.value = 'viewer';
  if (frm.status) frm.status.value = 'Active';
  if (frm.mfaEnabled) frm.mfaEnabled.value = 'false';

  // Family rows (clear)
  if (typeof fam !== 'undefined') { fam = []; if (typeof renderFamily === 'function') renderFamily(); }

  dlg.showModal();
}


// Tries several common endpoints; returns null if none work.
async function fetchFullStaff(id){
  const safeId = encodeURIComponent(id || '');
  const candidates = [
    `/api/staff/${safeId}`,        // REST style
    `/api/staff?id=${safeId}`,     // Query style
    `/api/staff/get/${safeId}`,    // Alt
    `/api/staffs/${safeId}`        // Plural
  ];
  for (const url of candidates){
    try{
      const r = await fetch(url, { headers: { 'Accept':'application/json' }});
      if (r.ok) return await r.json();
      if (r.status === 404) continue; // try next
    }catch(_){ /* ignore and continue */ }
  }
  return null;
}


  
  
async function openEdit(id){
  let x = null;
  if (id) x = await fetchFullStaff(id);         // try full doc
  if (!x) x = data.find(y => y._id === id);     // fallback to lite row
  if (!x){ alert('Could not load staff'); return; }

  frm.reset();
  const set = (n,v)=>{ if (frm.elements[n]) frm.elements[n].value = (v ?? ''); };
  set('_id', x._id || '');
  set('name', x.name);
  set('email', x.email);
  set('dept', x.dept);
  set('role', x.role || 'viewer');
  set('status', x.status || 'Active');
  set('mfaEnabled', x.mfaEnabled ? 'true' : 'false');
  set('notes', x.notes);
  set('staffNo', x.staffNo);
  set('hireDate', x.hireDate ? fmtDate(x.hireDate) : '');
  set('carReg', x.carReg);
  set('carDesc', x.carDesc);
  set('address', x.address);
  set('idNo', x.idNo);
  set('passportNo', x.passportNo);
  set('nokName', x.nokName);
  set('nokRelation', x.nokRelation);
  set('nokPhone', x.nokPhone);
  set('emergencyNotes', x.emergencyNotes);

  // family (accept either relationship or relation)
  if (typeof fam !== 'undefined') {
    fam = Array.isArray(x.family) ? x.family.map(m=>({
      name: m?.name || '',
      dob: m?.dob || '',
      relation: (m?.relationship ?? m?.relation ?? ''),
      phone: m?.phone || '',
      notes: m?.notes || ''
    })) : [];
    if (typeof renderFamily === 'function') renderFamily();
  }

  $('#dlgTitle').textContent='Edit Staff';
  dlg.showModal();
}
window.openEdit = openEdit;




  async function toggleStatus(id, current){
    const next = current==='Active' ? 'Suspended' : 'Active';
    if(!confirm(`Change status to ${next}?`)) return;
    const r = await fetch(`/api/staff/${id}/status`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ status: next })});
    if(!r.ok){ alert('Status change failed'); return; }
    await load();
  }
  window.toggleStatus = toggleStatus;

  async function doDelete(id){
    if(!confirm('Delete this staff? (Soft delete)')) return;
    const r = await fetch(`/api/staff/${id}`, { method:'DELETE' });
    if(!r.ok){ alert('Delete failed'); return; }
    await load();
  }
  window.doDelete = doDelete;

  $('#q').oninput = render; $('#fRole').onchange = render; $('#fStatus').onchange = render;
  $('#btnRefresh').onclick = load;

  load();
</script>

  <!-- Full details dialog (read-only) -->
<dialog id="dlgDetails">
<div class="dlg-h">
  <img src="/public/images/logo.jpg" onerror="this.src='images/logo.jpg'" alt="logo" style="height:22px;width:auto;border-radius:4px">
  <span>Staff details</span>
</div>

  <div class="dlg-b" id="detailsBody" style="max-height:60vh;overflow:auto"></div>
  <div class="dlg-f">
    <button class="btn" id="btnDetClose">Close</button>
    <button class="btn primary" id="btnDetPdf">Export PDF</button>
  </div>
</dialog>

<script>
  const dlgDetails = document.getElementById('dlgDetails');
  const detailsBody = document.getElementById('detailsBody');
  document.getElementById('btnDetClose').onclick = ()=> dlgDetails.close();
  document.getElementById('btnDetPdf').onclick = ()=> exportDetailsPdf();
  document.getElementById('btnAddFam').onclick = ()=> addFam();


let fam = []; // array of {name, dob, relation, phone, notes}

function renderFamily(){
  const rows = fam.map((m,i)=>`
    <div class="fam-row">
      <input placeholder="Full name" value="${escapeHtml(m.name||'')}" data-i="${i}" data-k="name">
      <input type="date" value="${m.dob ? fmtDate(m.dob) : ''}" data-i="${i}" data-k="dob">
      <input placeholder="Relationship" value="${escapeHtml(m.relation||'')}" data-i="${i}" data-k="relation">
      <input placeholder="Phone" value="${escapeHtml(m.phone||'')}" data-i="${i}" data-k="phone">
      <input placeholder="Notes" value="${escapeHtml(m.notes||'')}" data-i="${i}" data-k="notes">
      <button type="button" class="btn" onclick="delFam(${i})">Remove</button>
    </div>
  `).join('');
  document.getElementById('familyRows').innerHTML =
    rows || '<div class="muted">No family members yet.</div>';

  // wire inputs to state
  document.getElementById('familyRows').querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', (e)=>{
      const idx = Number(e.target.dataset.i);
      const key = e.target.dataset.k;
      let val = e.target.value;
      if(key === 'dob' && val) { val = new Date(val).toISOString(); }
      fam[idx][key] = val;
    });
  });
}

function addFam(m={name:'', dob:'', relation:'', phone:'', notes:''}){ fam.push(m); renderFamily(); }
window.delFam = (i)=>{ fam.splice(i,1); renderFamily(); };




  
  function renderDetails(x){
    const fld = (k)=> (x[k] ?? '').toString();
    const yesno = (b)=> b ? 'Yes' : 'No';
    let html = `
      <div class="grid2">
        <div><strong>Name</strong><br>${escapeHtml(fld('name'))}</div>
        <div><strong>Email</strong><br>${escapeHtml(fld('email'))}</div>
      </div>
      <div class="grid2">
        <div><strong>Department</strong><br>${escapeHtml(fld('dept'))}</div>
        <div><strong>Role</strong><br>${escapeHtml(fld('role'))}</div>
      </div>
      <div class="grid2">
        <div><strong>Status</strong><br>${escapeHtml(fld('status'))}</div>
        <div><strong>MFA Enabled</strong><br>${yesno(!!x.mfaEnabled)}</div>
      </div>
      <div class="grid2">
        <div><strong>Staff Number</strong><br>${escapeHtml(fld('staffNo'))}</div>
        <div><strong>Hire Date</strong><br>${fmtDate(fld('hireDate'))}</div>
      </div>
      <div class="grid2">
        <div><strong>Car Registration</strong><br>${escapeHtml(fld('carReg'))}</div>
        <div><strong>Car Make/Model</strong><br>${escapeHtml(fld('carDesc'))}</div>
      </div>
      <div><strong>Address</strong><br>${escapeHtml(fld('address'))}</div>
      <div class="grid2">
        <div><strong>IC / NRIC / ID</strong><br>${escapeHtml(fld('idNo'))}</div>
        <div><strong>Passport No.</strong><br>${escapeHtml(fld('passportNo'))}</div>
      </div>
      <div class="grid2">
        <div><strong>Next of Kin — Name</strong><br>${escapeHtml(fld('nokName'))}</div>
        <div><strong>Relation</strong><br>${escapeHtml(fld('nokRelation'))}</div>
      </div>
      <div class="grid2">
        <div><strong>Next of Kin — Phone</strong><br>${escapeHtml(fld('nokPhone'))}</div>
        <div><strong>Emergency Notes</strong><br>${escapeHtml(fld('emergencyNotes'))}</div>
      </div>
`;


   // --- add this inside renderDetails(x) after the next-of-kin section ---
const famHtml = (Array.isArray(x.family) && x.family.length)
 ? `<table style="width:100%;border-collapse:collapse;font-size:14px">
      <thead><tr>
        <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">Name</th>
        <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">DOB</th>
        <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">Relationship</th>
        <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">Phone</th>
        <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">Notes</th>
      </tr></thead>
      <tbody>
        ${x.family.map(m=>`
          <tr>
            <td style="padding:6px">${escapeHtml(m.name||'')}</td>
            <td style="padding:6px">${m.dob? fmtDate(m.dob):''}</td>
<td style="padding:6px">${escapeHtml((m.relationship || m.relation || ''))}</td>

            <td style="padding:6px">${escapeHtml(m.phone||'')}</td>
            <td style="padding:6px">${escapeHtml(m.notes||'')}</td>
          </tr>`).join('')}
      </tbody>
    </table>`
 : '<span class="muted">No family members listed</span>';

html += `
<div><strong>Family Members</strong><br>${famHtml}</div>
`;

  html += `
      <div class="grid2">
        <div><strong>Last login</strong><br>${fmtDate(fld('lastLoginAt'))}</div>
        <div><strong>Created</strong><br>${fmtDate(fld('createdAt'))}</div>
      </div>
      <div><strong>Notes</strong><br>${escapeHtml(fld('notes'))}</div>
    `;
    detailsBody.innerHTML = html;
  }

async function openDetails(id){
  // Try full record from server
  let full = null;
  if (id) full = await fetchFullStaff(id);

  // Fallback to the row in memory (so user still sees something)
  const lite = data.find(y => y._id === id);
  const record = full || lite;

  if (!record){
    alert('Could not load full details and no cached row found.');
    return;
  }

  lastDetails = record;          // also used by PDF
  renderDetails(record);         // Employment/Vehicle/etc come through here
  dlgDetails.showModal();
}
window.openDetails = openDetails;



  function exportDetailsPdf(){
  const w = window.open('', '_blank', 'width=900,height=1100');
  const css = `
    @page { margin: 20mm }
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f172a}
    header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    header img{height:28px;width:auto;border-radius:6px}
    header .tt{font-size:18px;font-weight:700}
    .date{font-size:12px;color:#64748b;margin-left:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .block{margin:8px 0;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;break-inside:avoid}
    strong{display:block;color:#111827}
    h2{font-size:14px;margin:14px 0 6px;color:#111827}
    table{width:100%;border-collapse:collapse;font-size:12.5px}
    th,td{padding:6px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    footer{position:fixed;left:0;right:0;bottom:0;margin:0 20mm 12mm 20mm;font-size:11px;color:#64748b}
    .disc{border-top:1px solid #e5e7eb;padding-top:6px}
  `;
  w.document.write('<!doctype html><html><head><title>Staff details</title><style>'+css+'</style></head><body>');

  // Header with logo + title + date
  const today = new Date().toISOString().slice(0,10);
  const logo = '/public/images/logo.jpg';
  w.document.write(
    `<header>
       <img src="${logo}" onerror="this.src='images/logo.jpg'">
       <div class="tt">Asianloop — Staff Details</div>
       <div class="date">Printed: ${today}</div>
     </header>`
  );

  // Capture the dialog content and split into blocks
  const wrapper = document.createElement('div'); 
  wrapper.innerHTML = detailsBody.innerHTML;

  // Optional: promote "Family Members" table to have standard table styling
  const famTbl = wrapper.querySelector('table');
  if (famTbl) famTbl.classList.add('fam-table');

  // Write as blocks (two-column grid)
  w.document.write('<div class="grid">');
  Array.from(wrapper.children).forEach(ch=>{
    w.document.write('<div class="block">'+ch.outerHTML+'</div>');
  });
  w.document.write('</div>');

  // Footer disclaimer
  w.document.write(
    `<footer>
       <div class="disc">
         This document is generated for internal use by Asianloop Sdn Bhd. 
         It may contain personal data and confidential information. 
         Unauthorised distribution is strictly prohibited. © ${new Date().getFullYear()} Asianloop.
       </div>
     </footer>`
  );

  w.document.write('</body></html>');
  w.document.close();
  w.focus();
  w.print();
}

</script>

</body>
</html>
