<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Staff Directory — Asianloop Admin</title>
<style>
  :root{
    --bg:#fff; --ink:#0f172a; --muted:#64748b; --card:#fafafa; --border:#e5e7eb;
    --accent:#2563eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--border);
    padding:14px 20px;display:flex;align-items:center;gap:12px}
  header h1{font-size:18px;margin:0}
  header a.back{font-size:13px;color:var(--muted);text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  main{max-width:1100px;margin:0 auto;padding:18px 20px 40px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{font-size:14px;padding:9px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  input,select{border:1px solid var(--border);border-radius:10px;padding:9px 12px;font-size:14px}
  .hint{font-size:12px;color:var(--muted)}
  .table{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);text-align:left;padding:10px}
  tbody td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top}
  tbody tr:hover{background:#fcfcfc}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
  .status.active{color:var(--ok);border-color:#ccebd6}
  .status.suspended{color:var(--bad);border-color:#f3b5b5}
  .right{display:flex;gap:6px;justify-content:flex-end}
  dialog{border:none;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:0;max-width:640px;width:96%}
  .dlg-h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600}
  .dlg-b{padding:16px;display:grid;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .dlg-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
  .muted{color:var(--muted)}
  .link{color:var(--accent);text-decoration:none}

    .fam-sec{border:1px solid var(--border);border-radius:12px;background:#fff;padding:12px}
  .fam-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .fam-rows{display:grid;gap:8px}
  .fam-row{display:grid;grid-template-columns:1.2fr 0.9fr 1fr 1fr 1fr auto;gap:8px;align-items:center}
  .fam-row input{border:1px solid var(--border);border-radius:10px;padding:9px 10px;font-size:14px;width:100%}
  @media (max-width: 900px){
    .fam-row{grid-template-columns:1fr 1fr;gap:6px}
    .fam-row button{justify-self:start}
  }

/* --- Dialog polish --- */
dialog{max-width:760px;width:96%}
.dlg-h{display:flex;align-items:center;gap:10px}
.dlg-b{max-height:60vh;overflow:auto}
.sec-title{margin:6px 0 0;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
.block{border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px}
.block + .block{margin-top:10px}
/* compact labels */
#frm label{font-size:13px;color:#111827}
#frm input, #frm select{background:#fff}
#frm .grid2{align-items:flex-start}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width: 900px){ .kv{grid-template-columns:1fr} }

/* Family table (details view) */
.fam-table{width:100%;border-collapse:collapse;font-size:14px}
.fam-table th,.fam-table td{padding:6px;text-align:left;border-bottom:1px solid var(--border)}



</style>
</head>
<body>
<header>
  <a class="back" href="/public/admin.html">← Admin</a>
  <h1>Staff Directory</h1>
</header>
<main>
  <div class="bar">
    <input id="q" placeholder="Search name/email/department…" />
    <select id="fRole">
      <option value="">All roles</option>
      <option>admin</option>
      <option>manager</option>
      <option>viewer</option>
    </select>
    <select id="fStatus">
      <option value="">All status</option>
      <option value="Active">Active</option>
      <option value="Suspended">Suspended</option>
    </select>
    <button class="btn" id="btnRefresh">Refresh</button>
    <div style="flex:1"></div>
    <button class="btn primary" id="btnNew">Add Staff</button>
  </div>

  <div class="table">
    <table id="tbl">
      <thead>
        <tr>
          <th style="width:22%">Name</th>
          <th style="width:26%">Email</th>
          <th style="width:14%">Dept</th>
          <th style="width:12%">Role</th>
          <th style="width:12%">Status</th>
          <th style="width:14%">Last login</th>
          <th style="width:170px"></th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="7" class="muted" style="padding:14px">Loading…</td></tr></tbody>
    </table>
  </div>

  <p class="hint" style="margin-top:10px">Note: Emails must be within your allowed domain (e.g., @asian-loop.com).</p>
</main>

<!-- Add/Edit dialog -->
<dialog id="dlg">
  <div class="dlg-h" id="dlgTitle">Add Staff</div>
  <form id="frm" class="dlg-b">
    <input type="hidden" name="_id" id="hid_id" value="">

<div class="sec-title">Basic</div>
<div class="block">
  <!-- Basic -->
  <div class="grid2">
    <label>Name<br><input name="name" required></label>
    <label>Email<br><input name="email" type="email" required></label>
  </div>
  <div class="grid2">
    <label>Department<br><input name="dept"></label>
    <label>Role<br>
      <select name="role" required>
        <option>viewer</option>
        <option>manager</option>
        <option>admin</option>
      </select>
    </label>
  </div>
  <div class="grid2">
    <label>Status<br>
      <select name="status" required>
        <option>Active</option>
        <option>Suspended</option>
      </select>
    </label>
    <label>MFA Enabled?<br>
      <select name="mfaEnabled">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>
    </label>
  </div>
</div>

<div class="sec-title">Employment</div>
<div class="block">
  <div class="grid2">
    <label>Staff Number<br><input name="staffNo" placeholder="e.g., AL-0012"></label>
    <label>Hire Date<br><input name="hireDate" type="date"></label>
  </div>
</div>

<div class="sec-title">Vehicle</div>
<div class="block">
  <div class="grid2">
    <label>Car Registration<br><input name="carReg" placeholder="e.g., VBR 1234"></label>
    <label>Car Make/Model<br><input name="carDesc" placeholder="e.g., Perodua Myvi"></label>
  </div>
</div>

<div class="sec-title">Identity</div>
<div class="block">
  <div class="grid2">
    <label>IC / NRIC / ID No.<br><input name="idNo" placeholder="e.g., 900101-14-5678"></label>
    <label>Passport No.<br><input name="passportNo" placeholder="e.g., A12345678"></label>
  </div>
</div>

<div class="sec-title">Address</div>
<div class="block">
  <label>Address<br><input name="address" placeholder="Street, City, State, Postcode, Country"></label>
</div>

<div class="sec-title">Next of Kin</div>
<div class="block">
  <div class="grid2">
    <label>Next of Kin — Name<br><input name="nokName" placeholder="e.g., Nur Aisyah"></label>
    <label>Relation<br><input name="nokRelation" placeholder="e.g., Spouse"></label>
  </div>
  <div class="grid2">
    <label>Phone<br><input name="nokPhone" placeholder="+60-..."></label>
    <label>Emergency Notes (optional)<br><input name="emergencyNotes" placeholder="Allergies / conditions"></label>
  </div>
</div>

<div class="sec-title">Family Members</div>
<div class="block">
  <div class="fam-sec" style="border:none;padding:0">
    <div class="fam-head">
      <strong>Members</strong>
      <button type="button" class="btn" id="btnAddFam">+ Add member</button>
    </div>
    <div class="fam-rows" id="familyRows"></div>
    <div class="hint" style="margin-top:6px">Fields: Name, Date of Birth, Relationship, Phone, Notes</div>
  </div>
</div>

<div class="sec-title">Notes</div>
<div class="block">
  <label>Notes (optional)<br><input name="notes" placeholder=""></label>
</div>


    
 

<div class="dlg-f">
  <button type="button" class="btn" id="btnCancel">Cancel</button>
  <button type="button" class="btn primary" id="btnSave">Save</button>
</div>

</dialog>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---- ELEMENTS ----
  const $ = (q, el=document) => el.querySelector(q);
  const rowsEl      = $('#rows');
  const frm         = $('#frm');
  const dlg         = $('#dlg');
  const dlgTitle    = $('#dlgTitle');
  const dlgDetails  = $('#dlgDetails');
  const detailsBody = $('#detailsBody');

  const btnNew      = $('#btnNew');
  const btnSave     = $('#btnSave');
  const btnCancel   = $('#btnCancel');
  const btnRefresh  = $('#btnRefresh');

  // ---- STATE ----
  let data = [];
  let lastDetails = null;   // full record for Details/PDF
  let fam = [];             // family rows in the form (if used)

  // ---- HELPERS ----
  function escapeHtml(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }
  function fmtDate(v){
    if(!v) return '';
    const d = new Date(v);
    if (isNaN(d)) return escapeHtml(v);
    return d.toISOString().slice(0,10);
  }
  function pick(o, ...keys){
    for (const k of keys){
      const v = o && o[k];
      if (v !== undefined && v !== null && String(v).trim() !== '') return v;
    }
    return '';
  }
  function unwrapStaff(payload){
    if (!payload) return null;
    if (Array.isArray(payload)) return payload[0] || null;
    if (payload.data && typeof payload.data === 'object') return payload.data;
    if (payload.item && typeof payload.item === 'object') return payload.item;
    return payload;
  }

  async function fetchFullStaff(id){
    const safeId = encodeURIComponent(id || '');
    const candidates = [
      `/api/staff/${safeId}`,
      `/api/staff?id=${safeId}`,
      `/api/staff/get/${safeId}`,
      `/api/staffs/${safeId}`
    ];
    for (const url of candidates){
      try{
        const r = await fetch(url, { headers:{ 'Accept':'application/json' }});
        if (!r.ok){
          if (r.status === 404) continue;
          continue;
        }
        const raw = await r.json();
        const full = unwrapStaff(raw);
        if (full && typeof full === 'object'){
          const id2 =
            (full._id && typeof full._id === 'object' && full._id.$oid) ? full._id.$oid :
            (typeof full._id === 'string') ? full._id :
            (typeof full.id  === 'string') ? full.id : String(id || '');
          return { ...full, _id: id2 };
        }
      }catch(_){}
    }
    return null;
  }

  // ---- RENDER TABLE ----
  function render(){
    const q = ($('#q')?.value || '').trim().toLowerCase();
    const r = $('#fRole')?.value || '';
    const s = $('#fStatus')?.value || '';

    const filtered = (data||[]).filter(x=>{
      const okQ = !q || (String(x.name||'').toLowerCase().includes(q) || String(x.email||'').toLowerCase().includes(q) || String(x.dept||'').toLowerCase().includes(q));
      const okR = !r || x.role===r;
      const okS = !s || x.status===s;
      return okQ && okR && okS;
    });

    if(!filtered.length){
      rowsEl.innerHTML = `<tr><td colspan="7" class="muted" style="padding:14px">No staff</td></tr>`;
      return;
    }

    rowsEl.innerHTML = filtered.map(x=>{
      const st = x.status==='Active' ? 'active' : 'suspended';
      return `
        <tr>
          <td>${escapeHtml(x.name||'')}</td>
          <td>${escapeHtml(x.email||'')}</td>
          <td>${escapeHtml(x.dept||'')}</td>
          <td>${escapeHtml(x.role||'')}</td>
          <td><span class="status ${st}">${escapeHtml(x.status||'')}</span></td>
          <td>${fmtDate(x.lastLoginAt)}</td>
          <td class="right">
            <button class="btn view"   data-id="${x._id}">Details</button>
            <button class="btn edit"   data-id="${x._id}">Edit</button>
            <button class="btn toggle" data-id="${x._id}" data-status="${x.status||'Active'}">${x.status==='Active'?'Disable':'Enable'}</button>
            <button class="btn del"    data-id="${x._id}">Delete</button>
          </td>
        </tr>`;
    }).join('');
  }

  // ---- ROW BUTTONS (event delegation) ----
  rowsEl.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button');
    if (!btn) return;
    const id = btn.dataset.id;
    if (!id) return;

    if (btn.classList.contains('view')) {
      openDetails(String(id));
    } else if (btn.classList.contains('edit')) {
      openEdit(String(id));
    } else if (btn.classList.contains('toggle')) {
      toggleStatus(String(id), btn.dataset.status || 'Active');
    } else if (btn.classList.contains('del')) {
      doDelete(String(id));
    }
  });

  // ---- DETAILS RENDERER ----
  function renderDetails(x){
    // Build Details body using aliases via pick()
    detailsBody.innerHTML = `
      <div class="grid2">
        <div><strong>Name</strong><div>${escapeHtml(x.name||'')}</div></div>
        <div><strong>Email</strong><div>${escapeHtml(x.email||'')}</div></div>
      </div>

      <h2 class="sec-title">Employment</h2>
      <div class="grid2">
        <div><strong>Staff Number</strong><div>${escapeHtml(pick(x,'staffNo','staff_number','staff_no'))}</div></div>
        <div><strong>Hire Date</strong><div>${escapeHtml(pick(x,'hireDate','hire_date'))}</div></div>
      </div>

      <h2 class="sec-title">Vehicle</h2>
      <div class="grid2">
        <div><strong>Car Registration</strong><div>${escapeHtml(pick(x,'carReg','car_reg','carRegistration'))}</div></div>
        <div><strong>Car Make/Model</strong><div>${escapeHtml(pick(x,'carDesc','car_desc','carMakeModel'))}</div></div>
      </div>

      <h2 class="sec-title">Identity</h2>
      <div class="grid2">
        <div><strong>IC / NRIC / ID</strong><div>${escapeHtml(pick(x,'idNo','ic','nric'))}</div></div>
        <div><strong>Passport No.</strong><div>${escapeHtml(pick(x,'passportNo','passport_no'))}</div></div>
      </div>

      <h2 class="sec-title">Address</h2>
      <div class="grid2">
        <div><strong>Address</strong><div>${escapeHtml(pick(x,'address','addr'))}</div></div>
      </div>

      <h2 class="sec-title">Next of Kin</h2>
      <div class="grid2">
        <div><strong>Next of Kin — Name</strong><div>${escapeHtml(pick(x,'nokName','nextOfKinName'))}</div></div>
        <div><strong>Relation</strong><div>${escapeHtml(pick(x,'nokRelation','nextOfKinRelation','relation'))}</div></div>
        <div><strong>Next of Kin — Phone</strong><div>${escapeHtml(pick(x,'nokPhone','nextOfKinPhone'))}</div></div>
        <div><strong>Emergency Notes</strong><div>${escapeHtml(pick(x,'emergencyNotes','emergency_notes'))}</div></div>
      </div>
    `;
  }

  // ---- OPENERS ----
  async function openDetails(id){
    let full = null;
    if (id) full = await fetchFullStaff(id);
    const lite = data.find(y => String(y && y._id) === String(id));
    const record = full || lite;
    if (!record){ alert('Could not load full details and no cached row found.'); return; }
    lastDetails = record;
    renderDetails(record);
    dlgDetails.showModal();
  }
  window.openDetails = openDetails; // in case inline attrs exist elsewhere

  async function openEdit(id){
    let x = null;
    if (id) x = await fetchFullStaff(id);
    if (!x) x = data.find(y => String(y && y._id) === String(id));
    if (!x){ alert('Could not load staff'); return; }

    frm.reset();
    const set = (n,v)=>{ if (frm.elements[n]) frm.elements[n].value = (v ?? ''); };

    set('_id', x._id || '');
    set('name', x.name);
    set('email', x.email);
    set('dept', x.dept);
    set('role', (x.role || 'viewer'));
    set('status', (x.status || 'Active'));
    set('mfaEnabled', x.mfaEnabled ? 'true' : 'false');
    set('notes', x.notes);

    set('staffNo', x.staffNo);
    set('hireDate', x.hireDate ? fmtDate(x.hireDate) : '');
    set('carReg', x.carReg);
    set('carDesc', x.carDesc);
    set('address', x.address);
    set('idNo', x.idNo);
    set('passportNo', x.passportNo);
    set('nokName', x.nokName);
    set('nokRelation', (x.nokRelation || x.nextOfKinRelation || ''));
    set('nokPhone', x.nokPhone);
    set('emergencyNotes', x.emergencyNotes);

    // Family (optional)
    if (typeof fam !== 'undefined'){
      fam = Array.isArray(x.family) ? x.family.map(m=>({
        name: m?.name || '',
        dob: m?.dob || '',
        relation: (m?.relationship ?? m?.relation ?? ''),
        phone: m?.phone || '',
        notes: m?.notes || ''
      })) : [];
      if (typeof window.renderFamily === 'function') window.renderFamily();
    }

    dlgTitle.textContent = 'Edit Staff';
    dlg.showModal();
  }
  window.openEdit = openEdit;

  function openAdd(){
    dlgTitle.textContent = 'Add Staff';
    frm.reset();
    if (frm.elements['_id']) frm.elements['_id'].value = '';
    if (frm.role) frm.role.value='viewer';
    if (frm.status) frm.status.value='Active';
    if (frm.mfaEnabled) frm.mfaEnabled.value='false';
    if (typeof fam !== 'undefined'){ fam = []; if (typeof window.renderFamily === 'function') window.renderFamily(); }
    dlg.showModal();
  }

  // ---- SAVE ----
  async function saveStaff(e){
    if (e) e.preventDefault();

    // Build payload from form
    const obj = Object.fromEntries(new FormData(frm).entries());
    obj.mfaEnabled = (obj.mfaEnabled === 'true');

    // normalize aliases
    obj.staffNo        = obj.staffNo        || obj.staff_number || obj.staff_no || '';
    obj.hireDate       = obj.hireDate       || obj.hire_date    || '';
    obj.carReg         = obj.carReg         || obj.car_reg      || obj.carRegistration || '';
    obj.carDesc        = obj.carDesc        || obj.car_desc     || obj.carMakeModel    || '';
    obj.address        = obj.address        || obj.addr         || '';
    obj.idNo           = obj.idNo           || obj.ic           || obj.nric || '';
    obj.passportNo     = obj.passportNo     || obj.passport_no  || '';
    obj.nokName        = obj.nokName        || obj.nextOfKinName || '';
    obj.nokRelation    = obj.nokRelation    || obj.nextOfKinRelation || obj.relation || '';
    obj.nokPhone       = obj.nokPhone       || obj.nextOfKinPhone || '';
    obj.emergencyNotes = obj.emergencyNotes || obj.emergency_notes || '';

    if (obj.hireDate && /^\d{4}-\d{2}-\d{2}/.test(obj.hireDate) === false){
      const d = new Date(obj.hireDate);
      if (!isNaN(d)) obj.hireDate = d.toISOString().slice(0,10);
    }

    // family
    const famClean = (Array.isArray(fam) ? fam : []).map(m => ({
      name: (m?.name || '').trim(),
      dob:  m?.dob || '',
      relationship: (m?.relation || m?.relationship || '').trim(),
      phone: (m?.phone || '').trim(),
      notes: (m?.notes || '').trim(),
    })).filter(m => m.name || m.relationship || m.phone || m.notes || m.dob);
    obj.family = famClean;

    let method = 'POST', url = '/api/staff';
    if (obj._id) { method = 'PUT'; url = `/api/staff/${encodeURIComponent(obj._id)}`; }

    if (btnSave){ btnSave.disabled = true; btnSave.textContent = 'Saving…'; }
    try{
      const r = await fetch(url, {
        method,
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(obj)
      });
      if (!r.ok){
        const t = await r.text().catch(()=>r.statusText||'');
        alert('Save failed: ' + (t || `${r.status} ${r.statusText}`));
        return;
      }
      dlg.close();
      await load();
    } finally {
      if (btnSave){ btnSave.disabled = false; btnSave.textContent = 'Save'; }
    }
  }

  // ---- LOAD ----
  async function load(){
    rowsEl.innerHTML = `<tr><td colspan="7" class="muted" style="padding:14px">Loading...</td></tr>`;
    try{
      const r = await fetch('/api/staff', { headers:{ 'Accept':'application/json' }});
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      const j = await r.json();

      const arr = Array.isArray(j) ? j : (Array.isArray(j.items) ? j.items : []);
      data = arr.map(x => {
        const id =
          (x && x._id && typeof x._id === 'object' && x._id.$oid) ? x._id.$oid :
          (x && typeof x._id === 'string') ? x._id :
          (x && typeof x.id  === 'string') ? x.id : '';
        return { ...x, _id: id };
      });
    }catch(e){
      console.error('[load]', e);
      data = [];
    }
    render();
  }

  // ---- WIRING ----
  // prevent native submit validation (dialogs hide fields -> "not focusable")
  if (frm){
    frm.setAttribute('novalidate','');
    frm.addEventListener('submit', (e)=> e.preventDefault());
  }
  if (btnSave){ btnSave.setAttribute('type','button'); btnSave.addEventListener('click', saveStaff); }
  if (btnCancel){ btnCancel.setAttribute('type','button'); btnCancel.addEventListener('click', ()=> dlg.close()); }
  if (btnNew){ btnNew.addEventListener('click', openAdd); }
  if (btnRefresh){ btnRefresh.addEventListener('click', load); }

  // filters trigger re-render
  $('#q')?.addEventListener('input', render);
  $('#fRole')?.addEventListener('change', render);
  $('#fStatus')?.addEventListener('change', render);

  // kick off
  load();
});
</script>


</body>
</html>
