<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Staff Directory — Asianloop Admin</title>
<style>
  :root{
    --bg:#fff; --ink:#0f172a; --muted:#64748b; --card:#fafafa; --border:#e5e7eb;
    --accent:#2563eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--border);
    padding:14px 20px;display:flex;align-items:center;gap:12px}
  header h1{font-size:18px;margin:0}
  header a.back{font-size:13px;color:var(--muted);text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  main{max-width:1100px;margin:0 auto;padding:18px 20px 40px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{font-size:14px;padding:9px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  input,select{border:1px solid var(--border);border-radius:10px;padding:9px 12px;font-size:14px}
  .hint{font-size:12px;color:var(--muted)}
.table{
  border:1px solid var(--border);
  border-radius:14px;
  background:#fff;
  /* was overflow:hidden; that was clipping the buttons */
  overflow:visible;
  padding-right:14px; /* add breathing room inside the rounded corner */
}

  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);text-align:left;padding:10px}
  tbody td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top}
  tbody tr:hover{background:#fcfcfc}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
  .status.active{color:var(--ok);border-color:#ccebd6}
  .status.suspended{color:var(--bad);border-color:#f3b5b5}
  .right{display:flex;gap:6px;justify-content:flex-end}
  dialog{border:none;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:0;max-width:640px;width:96%}
  .dlg-h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600}
  .dlg-b{padding:16px;display:grid;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .dlg-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
  .muted{color:var(--muted)}
  .link{color:var(--accent);text-decoration:none}

    .fam-sec{border:1px solid var(--border);border-radius:12px;background:#fff;padding:12px}
  .fam-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .fam-rows{display:grid;gap:8px}
  .fam-row{display:grid;grid-template-columns:1.2fr 0.9fr 1.2fr 1fr 1fr auto;gap:8px;align-items:center}
  .fam-row input{border:1px solid var(--border);border-radius:10px;padding:9px 10px;font-size:14px;width:100%}
  @media (max-width: 900px){
    .fam-row{grid-template-columns:1fr 1fr;gap:6px}
    .fam-row button{justify-self:start}
  }


/* --- Responsive dialog widths (Add/Edit & Full Details) --- */
/* Mobile-first: compact */
#dlg, #dlgDetails {
  width: 96%;
  max-width: 640px;   /* small on phones */
}

/* Medium screens (tablets / small laptops) */
@media (min-width: 900px) {
  #dlg        { max-width: 880px; }   /* Add/Edit dialog */
  #dlgDetails { max-width: 1000px; }  /* Full details dialog */
}

/* Large laptops / desktops */
@media (min-width: 1280px) {
  #dlg        { max-width: 1100px; }
  #dlgDetails { max-width: 1200px; }
}

/* Ensure the body is scrollable, footer stays visible */
#dlg .dlg-b, #dlgDetails .dlg-b {
  max-height: 70vh;
  overflow: auto;
}


/* === Wider input fields inside dialogs === */
#dlg label,
#dlgDetails label { display:block; }

/* Make all form controls fill their column */
#dlg input[type="text"],
#dlg input[type="email"],
#dlg input[type="date"],
#dlg input[type="number"],
#dlg input:not([type]),
#dlg select,
#dlg textarea {
  width: 100%;
  box-sizing: border-box;
}

/* Give family row a proper grid so inputs have room */
.fam-row {
  display: grid;
  grid-template-columns: 1.2fr 0.9fr 1fr 1fr 1.2fr auto; /* name, dob, rel, phone, notes, remove */
  gap: 10px;
}
.fam-row input { width: 100%; }

/* Compact on small screens; keep it readable */
@media (max-width: 699px) {
  .fam-row { grid-template-columns: 1fr; } /* stack on phones */
}

/* On larger screens, give dialog body more breathing room */
@media (min-width: 900px) {
  #dlg .dlg-b { padding-right: 4px; } /* avoid horizontal scrollbars */
}

/* Address grids */
.grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px }
.grid1{ display:grid; grid-template-columns: 1fr; gap:10px }
@media (max-width: 900px){
  .grid3{ grid-template-columns: 1fr; }
}

/* ===== TABLE LAYOUT (no clipping, aligned widths) ===== */
table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;         /* honor <colgroup> widths */
  min-width:1100px;
}
thead tr{ background: var(--table-head, #f5f7fb); }
thead th{ background: inherit; padding:12px 14px; text-align:left; }
th, td{ vertical-align:middle; padding:12px 14px; border-bottom:1px solid var(--border); }

/* Actions column */
th.actions{ text-align:right; padding-right:18px; }
td.actions{
  white-space:normal;
  overflow:visible;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:flex-end;
  align-items:center;
  padding-right:12px;         /* space from the rounded right edge */
}
td.actions .btn{
  font-size:12px;             /* small buttons */
  padding:5px 8px;
  margin:0;
  line-height:1.2;
}

/* Ensure the last cell never kisses the border */
tbody tr td:last-child{ padding-right:16px; }

/* Narrow screens: shrink actions a bit */
@media (max-width: 1100px){
  colgroup col:last-child{ width:360px !important; }
}




/* Export All button (green) */
.btn.success{
  background:#22c55e; /* green */
  color:#fff;
  border:1px solid #16a34a;
}
.btn.success:hover{ filter:brightness(.95); }


</style>
</head>
<body>
<header>
  <a class="back" href="/public/admin.html">← Admin</a>
  <h1>Staff Directory</h1>
</header>
<main>
  <div class="bar">
    <input id="q" placeholder="Search name/email/department…" />
<select id="fTier">
  <option value="">All tiers</option>
  <option>Senior Manager</option>
  <option>Manager</option>
  <option>Senior Executive</option>
  <option>Executive</option>
  <option>Non-Executive (T)</option>
  <option>Non-Executive (NT)</option>
</select>


    <select id="fStatus">
      <option value="">All status</option>
      <option value="Active">Active</option>
      <option value="Suspended">Suspended</option>
    </select>
    <button class="btn" id="btnRefresh">Refresh</button>
    <div style="flex:1"></div>
<div class="toolbar-right" style="display:flex; gap:10px; align-items:center">
  <button class="btn success" id="btnExportAll" title="Export all staff to CSV (Excel)">Export All</button>
  <button class="btn primary" id="btnNew">Add Staff</button>
</div>

  </div>

  <div class="table">
    <table id="tbl">
<!-- Column widths -->
<colgroup>
  <col style="width:50%">  <!-- Name -->
  <col style="width:30%">  <!-- Staff No -->
  <col style="width:45%">  <!-- Email -->
  <col style="width:30%">  <!-- Dept -->
  <col style="width:25%">  <!-- Tier -->
  <col style="width:30%">  <!-- Position -->
  <col style="width:12%">  <!-- Status -->
  <col style="width:420px"> <!-- Actions -->
</colgroup>


<thead>
  <tr>
    <th>Name</th>
    <th>Staff No</th>
    <th>Email</th>
    <th>Dept</th>
    <th>Tier</th>
    <th>Position</th>
    <th>Status</th>
    <th class="actions">Actions</th>
  </tr>
</thead>








      <tbody id="rows"><tr><td colspan="7" class="muted" style="padding:14px">Loading…</td></tr></tbody>
    </table>
  </div>

  <p class="hint" style="margin-top:10px">Note: Emails must be within your allowed domain (e.g., @asian-loop.com).</p>
</main>

<!-- Add/Edit dialog -->
<dialog id="dlg">
  <div class="dlg-h" id="dlgTitle">Add Staff</div>
  <form id="frm" class="dlg-b">
  <!-- Row 1 -->
  <div class="grid2">
    <label>Name<br><input name="name" required></label>
    <label>Work Email<br><input name="email" type="email" required placeholder="user@asian-loop.com"></label>
  </div>

  <!-- Row 2 -->
  <div class="grid2">
    <label>Personal Email<br><input name="personalEmail" type="email" placeholder="yourname@gmail.com"></label>
    <label>Position<br><input name="position" placeholder="e.g., Principal Measurement"></label>
  </div>

  <!-- Row 3 (the ONLY Department field + Tier) -->
  <div class="grid2">
    <label>Department<br><input name="dept"></label>
    <label>Tier<br>
      <select name="tier" required>
        <option>Senior Manager</option>
        <option>Manager</option>
        <option>Senior Executive</option>
        <option>Executive</option>
        <option>Non-Executive (T)</option>
        <option>Non-Executive (NT)</option>
      </select>
    </label>
  </div>





  <div class="grid2">
<label>Status<br>
  <select name="status" required>
    <option>Active</option>
    <option>Suspended</option>
    <option>Resigned</option>
    <option>Retired</option>
    <option>Under Probation</option>
  </select>
</label>

    <label>MFA Enabled?<br>
      <select name="mfaEnabled">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>
    </label>
  </div>

  <!-- Extended details -->
  <div class="grid2">
    <label>Staff Number<br><input name="staffNo" placeholder="e.g., AL-0012"></label>
    <label>Car Registration<br><input name="carReg" placeholder="e.g., VBR 1234"></label>
  </div>

  <div class="grid2">
    <label>Car Make/Model<br><input name="carDesc" placeholder="e.g., Perodua Myvi"></label>
    <label>Hire Date<br><input name="hireDate" type="date"></label>
  </div>

<div class="sec-title">Address</div>
<div class="block">
  <div class="grid2">
    <label>Address Line 1<br><input name="address1" placeholder="Street address (line 1)"></label>
    <label>Address Line 2 (optional)<br><input name="address2" placeholder="Apartment, suite, etc. (line 2)"></label>
  </div>
  <div class="grid3">
    <label>City<br><input name="city" placeholder="City / Town"></label>
    <label>State / Province<br><input name="state" placeholder="State / Province"></label>
    <label>Postcode / ZIP<br><input name="postcode" placeholder="Postcode / ZIP"></label>
  </div>
  <div class="grid1">
    <label>Country<br><input name="country" placeholder="Country"></label>
  </div>
</div>

  <div class="grid2">
    <label>IC / NRIC / ID No.<br><input name="idNo" placeholder="e.g., 900101-14-5678"></label>
    <label>Passport No.<br><input name="passportNo" placeholder="e.g., A12345678"></label>
  </div>

  <div class="grid2">
    <label>Next of Kin — Name<br><input name="nokName" placeholder="e.g., Nur Aisyah"></label>
<label>Relation<br>
  <select name="nokRelation">
    <option value="">Select relationship</option>
    <option>Spouse</option>
    <option>Parent</option>
    <option>Child</option>
    <option>Sibling</option>
    <option>Grandparent</option>
    <option>Grandchild</option>
    <option>Relative</option>
    <option>Guardian</option>
    <option>Emergency Contact</option>
    <option>Friend</option>
    <option>Colleague</option>
    <option>Other</option>
  </select>
</label>
  </div>

  <div class="grid2">
    <label>Next of Kin — Phone<br><input name="nokPhone" placeholder="+60-..."></label>
    <label>Emergency Notes (optional)<br><input name="emergencyNotes" placeholder="Allergies / conditions"></label>
  </div>

<div class="fam-sec">
  <div class="fam-head">
    <strong>Family Members</strong>
    <button type="button" class="btn" id="btnAddFam">+ Add member</button>
  </div>
  <div class="fam-rows" id="familyRows">
    <!-- rows injected by JS -->
  </div>
  <div class="hint" style="margin-top:6px">Fields: Name, Date of Birth, Relationship, Phone, Notes</div>
</div>


  <label>Notes (optional)<br><input name="notes" placeholder=""></label>
<input type="hidden" id="hid_id" name="_id" />

</form>

  <div class="dlg-f">
    <button class="btn" id="btnCancel">Cancel</button>
    <button class="btn primary" id="btnSave">Save</button>
  </div>
</dialog>

<script>
  const $ = (q, el=document) => el.querySelector(q);
  const rowsEl = $('#rows'); let data = [];
  let fam = []; // <- single global family array

  function fmtDate(d){ if(!d) return ''; const x=new Date(d); return isNaN(x)?'':x.toISOString().slice(0,10); }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// Friendly labels for table display
const roleLabel = (v)=>{
  if (v === 'admin')   return 'Management';
  if (v === 'manager') return 'Non-Executive';
  return 'Executive'; // viewer
};

// Map old role values to new Tier display if no 'tier' stored yet
function tierDisplay(x){
  if (x && x.tier) return x.tier;
  // legacy role fallback:
  if (x && x.role === 'admin')   return 'Senior Manager';
  if (x && x.role === 'manager') return 'Manager';
  return 'Executive'; // viewer or missing
}
function statusClass(s){
  if (s === 'Active') return 'active';
  if (s === 'Suspended') return 'suspended';
  return ''; // other statuses unstyled (Resigned, Retired, Under Probation)
}

  
function render(){
  const q = ($('#q')?.value || '').trim().toLowerCase();
const t = $('#fTier')?.value || '';
  const s = $('#fStatus')?.value || '';

const filtered = (data||[]).filter(x=>{
  const okQ = !q || (
    String(x.name||'').toLowerCase().includes(q) ||
    String(x.email||'').toLowerCase().includes(q) ||
    String(x.dept||'').toLowerCase().includes(q) ||
    String(x.position||'').toLowerCase().includes(q)
  );
  const tierVal = tierDisplay(x);
  const okT = !t || tierVal === t;
  const okS = !s || x.status === s;
  return okQ && okT && okS;
});


  if(!filtered.length){
    rowsEl.innerHTML = `<tr><td colspan="7" class="muted" style="padding:14px">No staff</td></tr>`;
    return;
  }

  rowsEl.innerHTML = filtered.map(x=>{
    const stCls = x.status==='Active' ? 'active' : 'suspended';
    const staffNo = x.staffNo || x.staff_number || x.staff_no || '';
    return `
      <tr>
       <td>${escapeHtml(x.name||'')}</td>
<td>${escapeHtml(staffNo)}</td>
<td>${escapeHtml(x.email||'')}</td>
<td>${escapeHtml(x.dept||'')}</td>
<td>${escapeHtml(tierDisplay(x))}</td>
<td>${escapeHtml(x.position || '')}</td>
<td><span class="status ${statusClass(x.status)}">${escapeHtml(x.status||'')}</span></td>
<td class="actions">
  <button class="btn" onclick='openDetails("${x._id}")'>Details</button>
  <button class="btn" onclick='openEdit("${x._id}")'>Edit</button>
  <button class="btn" onclick='toggleStatus("${x._id}", "${x.status||"Active"}")'>${x.status==='Active'?'Disable':'Enable'}</button>
  <button class="btn" onclick='doDelete("${x._id}")'>Delete</button>
</td>


      </tr>`;
  }).join('');
}



  async function load(){
    try{
      const r = await fetch('/api/staff', { headers:{ 'Accept':'application/json' }});
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      const j = await r.json();

      const arr = Array.isArray(j) ? j : (Array.isArray(j.items) ? j.items : []);
data = (arr || []).map(x => {
  const id =
    (x && x._id && typeof x._id === 'object' && x._id.$oid) ? x._id.$oid :
    (x && typeof x._id === 'string') ? x._id :
    (x && typeof x.id  === 'string') ? x.id : '';

  const staffNoNorm = (x.staffNo || x.staff_number || x.staff_no || '');

  return { ...x, _id: id, staffNo: staffNoNorm };
});

    }catch(e){
      console.error('[load]', e);
      data = [];
    }
    render();
  }

  // dialogs
  const dlg = $('#dlg'); const frm = $('#frm');

  $('#btnNew').onclick = ()=>{
    frm.reset();
    (document.getElementById('hid_id')||{}).value = '';
    if (frm.role) frm.role.value = 'viewer';
    if (frm.status) frm.status.value = 'Active';
    if (frm.mfaEnabled) frm.mfaEnabled.value = 'false';

    // clear Family section
    fam = [];
    const famRows = document.getElementById('familyRows');
    if (famRows) famRows.innerHTML = '';
    if (typeof renderFamily === 'function') renderFamily();

    $('#dlgTitle').textContent = 'Add Staff';
    dlg.showModal();
  };

  $('#btnCancel').onclick = ()=>{
    dlg.close();
    // optional: clear family on cancel as well
    fam = [];
    const famRows = document.getElementById('familyRows');
    if (famRows) famRows.innerHTML = '';
  };

  $('#btnSave').onclick = async ()=>{
    const obj = Object.fromEntries(new FormData(frm).entries());
    obj.mfaEnabled = (obj.mfaEnabled === 'true');
    // --- build combined address string from structured fields ---
const parts = [
  (obj.address1||'').trim(),
  (obj.address2||'').trim(),
  (obj.city||'').trim(),
  (obj.state||'').trim(),
  (obj.postcode||'').trim(),
  (obj.country||'').trim()
].filter(Boolean);
obj.address = parts.join(', ');

// (optional) keep structured fields in payload for future use; backend can ignore


    // normalize fields
    obj.staffNo = obj.staffNo || obj.staff_number || obj.staff_no || '';
    obj.staff_number = obj.staffNo; // send snake_case too

    // family clean (relation -> relationship)
    const famClean = (Array.isArray(fam) ? fam : []).map(m => ({
      name: (m?.name || '').trim(),
      dob: m?.dob || '',
      relationship: (m?.relation || m?.relationship || '').trim(),
      phone: (m?.phone || '').trim(),
      notes: (m?.notes || '').trim(),
    })).filter(m => m.name || m.relationship || m.phone || m.notes || m.dob);
    obj.family = famClean;

    // decide create vs update using the hidden _id field
    const idField = String((document.getElementById('hid_id')?.value || '')).trim();
    let method, url;
    if (idField){
      method = 'PUT';
      url = `/api/staff/${encodeURIComponent(idField)}`;
      obj._id = idField;
    } else {
      method = 'POST';
      url = '/api/staff';
      delete obj._id;
    }

    const r = await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});
    if (!r.ok){
      const t = await r.text().catch(()=>r.statusText||'');
      alert('Save failed: ' + (t || `${r.status} ${r.statusText}`));
      return;
    }

    let saved = null;
    try { saved = await r.json(); } catch(_) {}

    const sentStaffNo = (obj.staffNo || obj.staff_number || obj.staff_no || '');

    // Always reload fresh list from server
    await load();
    data = data.map(d => ({ ...d, staffNo: (d.staffNo || d.staff_number || d.staff_no || '') }));
render();


    // Find the just-saved row by id (preferred) or email; then patch staffNo only
    let savedId =
      (saved && saved._id && typeof saved._id === 'object' && saved._id.$oid) ? saved._id.$oid :
      (saved && typeof saved._id === 'string') ? saved._id :
      (saved && typeof saved.id  === 'string') ? saved.id :
      (obj && obj._id) ? obj._id : '';

    let i = -1;
    if (savedId) i = data.findIndex(d => String(d && d._id) === String(savedId));
    if (i === -1 && obj.email){
      i = data.findIndex(d => String(d && d.email).toLowerCase() === String(obj.email).toLowerCase());
    }
    if (i > -1){
      data[i] = {
        ...data[i],
        staffNo: (saved?.staffNo || saved?.staff_number || saved?.staff_no || sentStaffNo)
      };
      render();
    }

    dlg.close();
  };

  // Fetch full staff by id; fallback to list row if detail route isn't available
  async function getStaff(id){
    try{
      const r = await fetch(`/api/staff/${id}`, { headers:{ 'Accept':'application/json' }});
      if (!r.ok) throw 0;
      const obj = await r.json();
      return obj && typeof obj === 'object' ? obj : (Array.isArray(obj) ? obj[0] : null);
    }catch(_){
      return data.find(y => y._id === id) || null;
    }
  }

  // Ensure openEdit writes the _id into the hidden field (so Save does PUT)
  function openEdit(id){
    const x = (data || []).find(y => String(y && y._id) === String(id));
    if (!x){ alert('Could not load staff'); return; }

    frm.reset();
    const set = (n,v)=>{ if (frm.elements[n]) frm.elements[n].value = (v ?? ''); };

    (document.getElementById('hid_id')||{}).value = x._id || '';

    set('name', x.name);
    set('email', x.email);
    set('dept', x.dept);

    set('status', x.status || 'Active');
    set('mfaEnabled', x.mfaEnabled ? 'true' : 'false');
    set('notes', x.notes);
    set('staffNo', x.staffNo || x.staff_number || x.staff_no || '');
    set('personalEmail', x.personalEmail);
set('tier', tierDisplay(x));
set('position', x.position);
// --- NEW: prefill remaining fields ---
set('carReg', x.carReg);
set('carDesc', x.carDesc);
set('hireDate', x.hireDate ? fmtDate(x.hireDate) : '');

set('idNo', x.idNo);
set('passportNo', x.passportNo);

set('nokName', x.nokName);
if (frm.nokRelation) frm.nokRelation.value = (x.nokRelation || ''); // select
set('nokPhone', x.nokPhone);
set('emergencyNotes', x.emergencyNotes);


// --- prefill structured address fields; prefer structured keys, fallback to single string ---
(function(){
  // If structured fields exist on the record, use them first:
  if (x.address1 || x.address2 || x.city || x.state || x.postcode || x.country) {
    if (frm.address1) frm.address1.value = x.address1 || '';
    if (frm.address2) frm.address2.value = x.address2 || '';
    if (frm.city)     frm.city.value     = x.city     || '';
    if (frm.state)    frm.state.value    = x.state    || '';
    if (frm.postcode) frm.postcode.value = x.postcode || '';
    if (frm.country)  frm.country.value  = x.country  || '';
    return;
  }
  // Fallback: try to split a single 'address' string into parts
  const addr = (typeof x.address === 'string' ? x.address : '')
    .split(',').map(s=>s.trim()).filter(Boolean);
  const [a1='', a2='', c='', st='', pc='', co=''] = [
    addr[0]||'', addr[1]||'', addr[2]||'', addr[3]||'', addr[4]||'', addr[5]||''
  ];
  if (frm.address1) frm.address1.value = a1;
  if (frm.address2) frm.address2.value = a2;
  if (frm.city)     frm.city.value     = c;
  if (frm.state)    frm.state.value    = st;
  if (frm.postcode) frm.postcode.value = pc;
  if (frm.country)  frm.country.value  = co;
})();


    
    // rebuild Family for this record
    fam = Array.isArray(x.family) ? x.family.map(m => ({
      name: m?.name || '',
      dob: m?.dob || '',
      relation: (m?.relationship ?? m?.relation ?? ''),
      phone: m?.phone || '',
      notes: m?.notes || ''
    })) : [];
    const famRows = document.getElementById('familyRows');
    if (famRows) famRows.innerHTML = '';
    if (typeof renderFamily === 'function') renderFamily();

    $('#dlgTitle').textContent = 'Edit Staff';
    dlg.showModal();
  }
  window.openEdit = openEdit;

  async function toggleStatus(id, current){
    const next = current==='Active' ? 'Suspended' : 'Active';
    if(!confirm(`Change status to ${next}?`)) return;
    const r = await fetch(`/api/staff/${id}/status`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ status: next })});
    if(!r.ok){ alert('Status change failed'); return; }
    await load();
  }
  window.toggleStatus = toggleStatus;

  async function doDelete(id){
    if(!confirm('Delete this staff? (Soft delete)')) return;
    const r = await fetch(`/api/staff/${id}`, { method:'DELETE' });
    if(!r.ok){ alert('Delete failed'); return; }
    await load();
  }
  window.doDelete = doDelete;

// filters
const qEl = $('#q');        if (qEl)      qEl.oninput   = render;
const tierEl = $('#fTier'); if (tierEl)   tierEl.onchange = render;
const statEl = $('#fStatus'); if (statEl) statEl.onchange = render;

  $('#btnRefresh').onclick = load;

  // --- Export all rows currently in `data` to CSV (Excel-friendly) ---
function exportAllCSV(){
  // headers
const headers = [
  'Name','Staff No','Work Email','Personal Email','Dept','Tier','Position','Status',
  'Hire Date','Car Reg','Car Make/Model','Address',
  'IC / NRIC / ID','Passport No',
  'Next of Kin Name','Next of Kin Relation','Next of Kin Phone','Emergency Notes',
  'Family'
];


  const esc = v => {
    const s = (v==null ? '' : String(v));
    // escape quotes/delims for CSV
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };

const ymd = v => {
  if (!v) return '';
  const d = new Date(v);
  return isNaN(d) ? String(v) : d.toISOString().slice(0,10);
};

  
 const rows = (data || []).map(d => {
  const staffNo = d.staffNo || d.staff_number || d.staff_no || '';
  const famStr = Array.isArray(d.family)
    ? d.family.map(m => {
        const name = m?.name || '';
        const rel  = (m?.relation || m?.relationship || '');
        const dob  = ymd(m?.dob);
        const tail = [rel, dob].filter(Boolean).join(', ');
        return [name, tail ? `(${tail})` : ''].filter(Boolean).join(' ');
      }).join('; ')
    : '';

return [
  d.name || '',
  staffNo,
  d.email || '',
  d.personalEmail || '',
  d.dept || '',
  tierDisplay(d) || '',
  d.position || '',
  d.status || '',
  ymd(d.hireDate) || '',
  d.carReg || '',
  d.carDesc || '',
  d.address || '',
  d.idNo || '',
  d.passportNo || '',
  d.nokName || '',
  d.nokRelation || '',
  d.nokPhone || '',
  d.emergencyNotes || '',
  famStr
].map(esc).join(',');

});


  const csv = ['\ufeff' + headers.join(','), ...rows].join('\n'); // BOM for Excel UTF-8
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `staff_export_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

document.getElementById('btnExportAll').onclick = exportAllCSV;

  
  load();
</script>

<!-- Full details dialog (read-only) -->
<dialog id="dlgDetails">
  <div class="dlg-h" style="display:flex;align-items:center;gap:10px">
    <img src="/public/images/logo.jpg" onerror="this.src='images/logo.jpg'" alt="logo" style="height:22px;width:auto;border-radius:4px">
    <span>Staff details</span>
  </div>
  <div class="dlg-b" id="detailsBody" style="max-height:60vh;overflow:auto"></div>
  <div class="dlg-f">
    <button class="btn" id="btnDetClose">Close</button>
    <button class="btn primary" id="btnDetPdf">Export PDF</button>
  </div>
</dialog>


<script>
  const dlgDetails = document.getElementById('dlgDetails');
  const detailsBody = document.getElementById('detailsBody');
  document.getElementById('btnDetClose').onclick = ()=> dlgDetails.close();
  document.getElementById('btnDetPdf').onclick = ()=> exportDetailsPdf();
  document.getElementById('btnAddFam')?.addEventListener('click', ()=> addFam());

// --- shared relationship options ---
const REL_OPTIONS = [
  'Spouse','Parent','Child','Sibling','Grandparent','Grandchild',
  'Relative','Guardian','Emergency Contact','Friend','Colleague','Other'
];
function relOptionsHTML(selected){
  const sel = String(selected||'');
  return REL_OPTIONS.map(opt=>{
    const s = (opt===sel) ? ' selected' : '';
    return `<option value="${opt}">${opt}</option>`;
  }).join('');
}


  
function renderFamily(){
  const rows = fam.map((m,i)=>`
    <div class="fam-row">
      <input placeholder="Full name" value="${escapeHtml(m.name||'')}" data-i="${i}" data-k="name">
      <input type="date" value="${m.dob ? fmtDate(m.dob) : ''}" data-i="${i}" data-k="dob">
      <select data-i="${i}" data-k="relation">
        <option value="">Select relationship</option>
        ${relOptionsHTML(m.relation)}
      </select>
      <input placeholder="Phone" value="${escapeHtml(m.phone||'')}" data-i="${i}" data-k="phone">
      <input placeholder="Notes" value="${escapeHtml(m.notes||'')}" data-i="${i}" data-k="notes">
      <button type="button" class="btn" onclick="delFam(${i})">Remove</button>
    </div>
  `).join('');

  const famRows = document.getElementById('familyRows');
  if (famRows) {
    famRows.innerHTML = rows || '<div class="muted">No family members yet.</div>';

    // wire inputs/selects to state
    famRows.querySelectorAll('input, select').forEach(inp=>{
      inp.addEventListener('input', (e)=>{
        const idx = Number(e.target.dataset.i);
        const key = e.target.dataset.k;
        let val = e.target.value;
        if(key === 'dob' && val) { val = new Date(val).toISOString(); }
        fam[idx][key] = val;
      });
      // for select, also listen to change (mobile browsers)
      inp.addEventListener('change', (e)=>{
        const idx = Number(e.target.dataset.i);
        const key = e.target.dataset.k;
        fam[idx][key] = e.target.value;
      });
    });
  }
}


function addFam(m={name:'', dob:'', relation:'', phone:'', notes:''}){ fam.push(m); renderFamily(); }
window.delFam = (i)=>{ fam.splice(i,1); renderFamily(); };



  function renderDetails(x){
  const body = document.getElementById('detailsBody');
  if (!body) return;

  const fld = (k)=> (x && x[k] !== undefined && x[k] !== null) ? String(x[k]) : '';
  const yesno = (b)=> b ? 'Yes' : 'No';

  let html = `
    <div class="grid2">
      <div><strong>Name</strong><br>${escapeHtml(fld('name'))}</div>
      <div><strong>Email</strong><br>${escapeHtml(fld('email'))}</div>
    </div>
<div class="grid2">
  <div><strong>Department</strong><br>${escapeHtml(fld('dept'))}</div>
  <div><strong>Tier</strong><br>${escapeHtml(tierDisplay(x))}</div>
</div>
<div><strong>Position</strong><br>${escapeHtml(x.position||'')}</div>

    <div class="grid2">
      <div><strong>Status</strong><br>${escapeHtml(fld('status'))}</div>
      <div><strong>MFA Enabled</strong><br>${yesno(!!x.mfaEnabled)}</div>
    </div>
    <div class="grid2">
      <div><strong>Staff Number</strong><br>${escapeHtml(x.staffNo || x.staff_number || x.staff_no || '')}</div>
      <div><strong>Hire Date</strong><br>${fmtDate(fld('hireDate'))}</div>
    </div>
    <div class="grid2">
      <div><strong>Car Registration</strong><br>${escapeHtml(fld('carReg'))}</div>
      <div><strong>Car Make/Model</strong><br>${escapeHtml(fld('carDesc'))}</div>
    </div>
<div><strong>Address</strong><br>${
  (()=>{
    const a1 = (x.address1||'').trim();
    const a2 = (x.address2||'').trim();
    const c  = (x.city||'').trim();
    const st = (x.state||'').trim();
    const pc = (x.postcode||'').trim();
    const co = (x.country||'').trim();
    const parts = [a1,a2,c, [st,pc].filter(Boolean).join(' '), co].filter(Boolean);
    if (parts.length) return escapeHtml(parts.join('\n')).replace(/\n/g,'<br>');
    // fallback to single string
    return escapeHtml((x.address||'').trim());
  })()
}</div>

    <div class="grid2">
      <div><strong>IC / NRIC / ID</strong><br>${escapeHtml(fld('idNo'))}</div>
      <div><strong>Passport No.</strong><br>${escapeHtml(fld('passportNo'))}</div>
    </div>
    <div class="grid2">
      <div><strong>Next of Kin — Name</strong><br>${escapeHtml(fld('nokName'))}</div>
      <div><strong>Relation</strong><br>${escapeHtml(fld('nokRelation'))}</div>
    </div>
    <div class="grid2">
      <div><strong>Next of Kin — Phone</strong><br>${escapeHtml(fld('nokPhone'))}</div>
      <div><strong>Emergency Notes</strong><br>${escapeHtml(fld('emergencyNotes'))}</div>
    </div>
  `;

  const famHtml = (Array.isArray(x.family) && x.family.length)
    ? `<table style="width:100%;border-collapse:collapse;font-size:14px">
        <thead><tr>
          <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">Name</th>
          <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">DOB</th>
          <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">Relationship</th>
          <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">Phone</th>
          <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px">Notes</th>
        </tr></thead>
        <tbody>
          ${x.family.map(m=>`
            <tr>
              <td style="padding:6px">${escapeHtml(m.name||'')}</td>
              <td style="padding:6px">${m.dob? fmtDate(m.dob):''}</td>
              <td style="padding:6px">${escapeHtml((m.relationship || m.relation || ''))}</td>
              <td style="padding:6px">${escapeHtml(m.phone||'')}</td>
              <td style="padding:6px">${escapeHtml(m.notes||'')}</td>
            </tr>`).join('')}
        </tbody>
      </table>`
    : '<span class="muted">No family members listed</span>';

  html += `<div><strong>Family Members</strong><br>${famHtml}</div>`;

  html += `
    <div class="grid2">
      <div><strong>Last login</strong><br>${fmtDate(fld('lastLoginAt'))}</div>
      <div><strong>Created</strong><br>${fmtDate(fld('createdAt'))}</div>
    </div>
    <div><strong>Notes</strong><br>${escapeHtml(fld('notes'))}</div>
  `;

  body.innerHTML = html;
}

  window.renderDetails = renderDetails;

// REPLACE your entire openDetails function with this
function openDetails(id){
  const rec = (data || []).find(d => String(d && d._id) === String(id));
  if (!rec) { alert('Could not load details.'); return; }

  // Call the details renderer if it exists; otherwise show a minimal fallback
  if (typeof window.renderDetails === 'function') {
    window.renderDetails(rec);
  } else {
    const body = document.getElementById('detailsBody');
    if (body) {
      body.innerHTML = `
        <div class="grid2">
          <div><strong>Name</strong><br>${escapeHtml(rec.name||'')}</div>
          <div><strong>Email</strong><br>${escapeHtml(rec.email||'')}</div>
        </div>
      `;
    }
  }
  document.getElementById('dlgDetails').showModal();
}
window.openDetails = openDetails;


function exportDetailsPdf(){
  const w = window.open('', '_blank', 'width=800,height=900');
  const css = `
    @page{ margin:20mm }
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:0 20mm 20mm;color:#0f172a}
    header{display:flex;align-items:center;gap:10px;margin:18px 0}
    header img{height:28px;width:auto;border-radius:6px}
    header .tt{font-size:18px;font-weight:700}
    header .date{margin-left:auto;font-size:12px;color:#64748b}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .block{margin:8px 0;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;break-inside:avoid}
    strong{display:block;color:#111827}
  `;
  w.document.write('<!doctype html><html><head><title>Staff details</title><style>'+css+'</style></head><body>');

  // Header with logo + title + date
  const logo = '/public/images/logo.jpg';
  const today = new Date().toISOString().slice(0,10);
  w.document.write(
    `<header>
       <img src="${logo}" onerror="this.src='images/logo.jpg'">
       <div class="tt">Asianloop — Staff Details</div>
       <div class="date">Printed: ${today}</div>
     </header>`
  );

  // Body copied from dialog content
  w.document.write('<div class="grid">');
  const wrapper = document.createElement('div');
  wrapper.innerHTML = detailsBody.innerHTML;
  Array.from(wrapper.children).forEach(ch=>{
    w.document.write('<div class="block">'+ch.outerHTML+'</div>');
  });
  w.document.write('</div>');

  w.document.write('</body></html>');
  w.document.close();
  w.focus();
  w.print();
}

</script>


</body>
</html>
