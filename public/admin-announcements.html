<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Announcements Admin</title>
<style>
  :root{ --bg:#fff; --ink:#0f172a; --muted:#64748b; --card:#fafafa; --border:#e5e7eb; --accent:#2563eb; --bad:#dc2626; }
  *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:12px}
  header h1{font-size:18px;margin:0}
  header a.back{font-size:13px;color:var(--muted);text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  main{max-width:1100px;margin:0 auto;padding:18px 20px 40px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{font-size:14px;padding:9px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.danger{border-color:#f2b7b7;color:#b80f0f;background:#fff}
  input,select,textarea{border:1px solid var(--border);border-radius:10px;padding:9px 12px;font-size:14px}
  .muted{color:var(--muted)}
  .table{border:1px solid var(--border);border-radius:14px;background:#fff;overflow:auto}
  table{width:100%;border-collapse:collapse;table-layout:fixed;min-width:1000px;font-size:14px}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);text-align:left;padding:10px}
  tbody td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top}
  tbody tr:hover{background:#fcfcfc}
  thead th.actions{text-align:right} td.actions{display:flex;gap:6px;justify-content:flex-end}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
  .st-deployed{color:#065f46;border-color:#a7f3d0}
  .st-scheduled{color:#92400e;border-color:#fcd34d}
  .st-ended{color:#7c2d12;border-color:#fecaca}
  .st-draft{color:#374151;border-color:#e5e7eb}
  dialog{border:none;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.12);padding:0;max-width:1200px;width:min(96vw,1200px)}

  .dlg-h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600}
  .dlg-b{padding:16px;display:grid;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid1{display:grid;grid-template-columns:1fr;gap:10px}
  .dlg-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:space-between;align-items:center}
  .hint{font-size:12px;color:var(--muted)}


/* Make form fields span full dialog width */
#dlg .dlg-b{ max-width:none }
#dlg label{ display:block; width:100% }
#dlg input, #dlg select, #dlg textarea{ width:100% !important; }

/* Make the two date inputs also stretch inside their 2-col row */
#dlg .grid2 > label > input{ width:100% !important; }


</style>
</head>
<body>
<header>
  <a class="back" href="/public/admin.html">← Admin</a>
  <h1>Announcements Admin</h1>
</header>

<main>
  <div class="bar">
    <input id="q" placeholder="Search title/category/author…"/>
    <select id="fState" title="Filter">
      <option value="">All</option>
      <option value="deployed">Deployed (live)</option>
      <option value="scheduled">Scheduled</option>
      <option value="ended">Ended</option>
      <option value="draft">Draft</option>
    </select>
    <button class="btn" id="btnRefresh">Refresh</button>
    <div style="flex:1"></div>
    <button class="btn primary" id="btnNew">New Announcement</button>
  </div>

  <div class="table">
    <table id="tbl">
      <colgroup>
        <col style="width:28%"><col style="width:14%"><col style="width:14%"><col style="width:12%"><col style="width:12%"><col style="width:20%">
      </colgroup>
      <thead>
        <tr>
          <th>Title</th>
          <th>Start</th>
          <th>End</th>
          <th>Status</th>
          <th>Deployed</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="6" class="muted" style="padding:14px">Loading…</td></tr></tbody>
    </table>
  </div>
  <p class="hint">Deploy = visible on dashboard during the scheduled window. You may keep past items as undeployed history.</p>
</main>

<dialog id="dlg">
  <div class="dlg-h" id="dlgTitle">New Announcement</div>
  <form id="frm" class="dlg-b">
    <input type="hidden" name="_id" id="hid_id" />
    <div class="grid1">
      <label>Title<br><input name="title" required placeholder="Short headline"/></label>
      <label>Category<br><input name="category" placeholder="e.g., Security, Events"/></label>
      <label>Body<br><textarea name="body" rows="5" placeholder="Main announcement text" required></textarea></label>
    </div>
    <div class="grid2">
      <label>Start (local)<br><input type="datetime-local" name="startAt" required></label>
      <label>End (local)<br><input type="datetime-local" name="endAt" required></label>
    </div>
    <div class="grid2">
      <label><input type="checkbox" name="pinned"> Pin to top</label>
      <label><input type="checkbox" name="deployNow"> Deploy immediately</label>
    </div>
  </form>
  <div class="dlg-f">
    <button class="btn danger" id="btnDelete" type="button">Delete</button>
    <div>
      <button class="btn" id="btnCancel" type="button">Cancel</button>
      <button class="btn primary" id="btnSave" type="button">Save</button>
    </div>
  </div>
</dialog>

<script>
const $ = (q, el=document)=>el.querySelector(q);
const rowsEl = $('#rows'); let data = [];
function fmt(d){ if(!d) return ''; const x=new Date(d); if(isNaN(x)) return ''; return x.toISOString().slice(0,16).replace('T',' '); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function stateOf(x){
  const now = Date.now(), s = x.startAt?+new Date(x.startAt):0, e = x.endAt?+new Date(x.endAt):0;
  if (x.deleted) return 'ended';
  if (x.deployed && s<=now && now<e) return 'deployed';
  if (now< s) return 'scheduled';
  if (now>=e) return 'ended';
  return 'draft';
}
function badgeCls(st){ return st==='deployed'?'st-deployed':st==='scheduled'?'st-scheduled':st==='ended'?'st-ended':'st-draft'; }

function buildRow(x){
  const id = String(x._id||'');
  const st = stateOf(x);
  const deployed = x.deployed ? 'Yes' : 'No';
  return [
    '<tr>',
      '<td>', escapeHtml(x.title||''), '</td>',
      '<td>', escapeHtml(fmt(x.startAt)), '</td>',
      '<td>', escapeHtml(fmt(x.endAt)), '</td>',
      '<td><span class="status ', badgeCls(st),'">', st, '</span></td>',
      '<td>', deployed, '</td>',
      '<td class="actions">',
        '<button class="btn js-edit" data-id="',id,'">Edit</button>',
        x.deployed
          ? '<button class="btn js-undep" data-id="'+id+'">Undeploy</button>'
          : '<button class="btn js-dep"  data-id="'+id+'">Deploy</button>',
      '</td>',
    '</tr>'
  ].join('');
}

async function load(){
  try{
    const r = await fetch('/api/admin/announcements', { headers:{'Accept':'application/json'} });
    data = (await r.json()) || [];
  }catch(_){ data=[]; }
  render();
}
function render(){
  const q = ($('#q')?.value||'').toLowerCase().trim();
  const fs = $('#fState')?.value || '';
  const filtered = data.filter(x=>{
    const okQ = !q || [x.title,x.category,x.authorEmail].some(v=>String(v||'').toLowerCase().includes(q));
    const st = stateOf(x);
    const okS = !fs || fs===st;
    return okQ && okS;
  });
  rowsEl.innerHTML = filtered.length ? filtered.map(buildRow).join('') :
    '<tr><td colspan="6" class="muted" style="padding:14px">No announcements</td></tr>';

  rowsEl.querySelectorAll('.js-edit').forEach(b=>b.addEventListener('click',()=>openEdit(b.dataset.id)));
  rowsEl.querySelectorAll('.js-dep').forEach(b=>b.addEventListener('click',()=>deploy(b.dataset.id,true)));
  rowsEl.querySelectorAll('.js-undep').forEach(b=>b.addEventListener('click',()=>deploy(b.dataset.id,false)));
}
$('#q').oninput = render; $('#fState').onchange = render; $('#btnRefresh').onclick = load;

const dlg = $('#dlg'), frm = $('#frm');
$('#btnNew').onclick = ()=>{ frm.reset(); $('#hid_id').value=''; $('#btnDelete').style.visibility='hidden'; $('#dlgTitle').textContent='New Announcement'; dlg.showModal(); };
$('#btnCancel').onclick = ()=> dlg.close();

function fillForm(x){
  const set=(n,v)=>{ if(frm.elements[n]) frm.elements[n].value = v ?? ''; };
  $('#hid_id').value = x._id||'';
  set('title', x.title); set('category', x.category); frm.body.value = x.body||'';
  set('startAt', x.startAt ? new Date(x.startAt).toISOString().slice(0,16) : '');
  set('endAt',   x.endAt   ? new Date(x.endAt).toISOString().slice(0,16) : '');
  frm.pinned.checked = !!x.pinned;
  frm.deployNow.checked = !!x.deployed;
}
function getForm(){
  const o = Object.fromEntries(new FormData(frm).entries());
  o.pinned = !!frm.pinned.checked; o.deployNow = !!frm.deployNow.checked;
  return o;
}
function openEdit(id){
  const x = data.find(y=>String(y._id)===String(id));
  if(!x) return alert('Not found');
  fillForm(x); $('#btnDelete').style.visibility='visible'; $('#dlgTitle').textContent='Edit Announcement'; dlg.showModal();
}
async function deploy(id, turnOn){
  try{
    const r = await fetch(`/api/admin/announcements/${id}/deploy`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ deployed: !!turnOn }) });
    if(!r.ok) throw new Error(await r.text());
    await load();
  }catch(e){ alert('Deploy toggle failed: '+ e.message); }
}
$('#btnDelete').onclick = async ()=>{
  const id = $('#hid_id').value.trim(); if(!id) return;
  if(!confirm('Delete this announcement?')) return;
  const r = await fetch(`/api/admin/announcements/${id}`, { method:'DELETE' });
  if(!r.ok){ alert('Delete failed'); return; }
  dlg.close(); await load();
};
$('#btnSave').onclick = async ()=>{
  const id = $('#hid_id').value.trim();
  const o = getForm();
  // convert datetime-local (no TZ) to ISO using local time
  const toIso = v => v ? new Date(v.replace(' ','T')).toISOString() : null;
  o.startAt = toIso(o.startAt); o.endAt = toIso(o.endAt);
  const url = id ? `/api/admin/announcements/${id}` : '/api/admin/announcements';
  const method = id ? 'PUT' : 'POST';
  const r = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(o) });
  if(!r.ok){ alert('Save failed'); return; }
  dlg.close(); await load();
};

load();
</script>
</body>
</html>
